<!DOCTYPE html>
<html>
<!-- This is an automatically generated file.  Do not edit.
   Automatically generated by Pod::Man 4.14 (Pod::Simple 3.42)
  
   Standard preamble:
   ========================================================================
   Vertical space (when we can't use .PP)
 -->
<head>

<style>
@media (prefers-color-scheme: dark) {
  body {
    background: #000;
    color: #d0d0d0;
  }

  a, a:visited {
    color: #1899eb;
  }
}
</style>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    table.head, table.foot { width: 100%; }
    td.head-rtitle, td.foot-os { text-align: right; }
    td.head-vol { text-align: center; }
    .Nd, .Bf, .Op { display: inline; }
    .Pa, .Ad { font-style: italic; }
    .Ms { font-weight: bold; }
    .Bl-diag > dt { font-weight: bold; }
    code.Nm, .Fl, .Cm, .Ic, code.In, .Fd, .Fn, .Cd { font-weight: bold;
      font-family: inherit; }
  </style>
  <title>Mail::SPF::Server(3)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">Mail::SPF::Server(3)</td>
    <td class="head-vol">User Contributed Perl Documentation</td>
    <td class="head-rtitle">Mail::SPF::Server(3)</td>
  </tr>
</table>
<div class="manual-text">
<br/>
<section class="Sh">
<h1 class="Sh" id="NAME"><a class="permalink" href="#NAME">NAME</a></h1>
<p class="Pp">Mail::SPF::Server - Server class for processing SPF requests</p>
</section>
<section class="Sh">
<h1 class="Sh" id="SYNOPSIS"><a class="permalink" href="#SYNOPSIS">SYNOPSIS</a></h1>
<pre>    use Mail::SPF;
    my $spf_server  = Mail::SPF::Server-&gt;new(
        # Optional custom default for authority explanation:
        default_authority_explanation =&gt;
            'See http://www.%{d}/why/id=%{S};ip=%{I};r=%{R}'
    );
    my $result      = $spf_server-&gt;process($request);
</pre>
</section>
<section class="Sh">
<h1 class="Sh" id="DESCRIPTION"><a class="permalink" href="#DESCRIPTION">DESCRIPTION</a></h1>
<p class="Pp"><b>Mail::SPF::Server</b> is a server class for processing SPF
    requests. Each server instance can be configured with specific processing
    parameters. Also, the default <i>Net::DNS::Resolver</i> DNS resolver used
    for making DNS look-ups can be overridden with a custom resolver object.</p>
<section class="Ss">
<h2 class="Ss" id="Constructor"><a class="permalink" href="#Constructor">Constructor</a></h2>
<p class="Pp">The following constructor is provided:</p>
<dl class="Bl-tag">
  <dt id="new(_options)"><a class="permalink" href="#new(_options)"><b>new(%options)</b>:
    returns <i>Mail::SPF::Server</i></a></dt>
  <dd>Creates a new server object for processing SPF requests.
    <p class="Pp"><span class="Li">%options</span> is a list of key/value pairs
        representing any of the following options:</p>
  </dd>
</dl>
<div class="Bd-indent">
<dl class="Bl-tag">
  <dt id="default_authority_explanation"><a class="permalink" href="#default_authority_explanation"><b>default_authority_explanation</b></a></dt>
  <dd>A <i>string</i> denoting the default (not macro-expanded) authority
      explanation string to use if the authority domain does not specify an
      explanation string of its own. Defaults to:
    <p class="Pp"></p>
    <pre>    'Please see http://www.openspf.org/Why?s=%{_scope};id=%{S};ip=%{C};r=%{R}'
    </pre>
    <p class="Pp">As can be seen from the default, a non-standard
        <span class="Li">&quot;_scope&quot;</span> pseudo macro is supported
        that expands to the name of the identity's scope. (Note: Do <i>not</i>
        use any non-standard macros in explanation strings published in
      DNS.)</p>
  </dd>
  <dt id="hostname"><a class="permalink" href="#hostname"><b>hostname</b></a></dt>
  <dd>A <i>string</i> denoting the local system's fully qualified host name that
      should be used for expanding the <span class="Li">&quot;r&quot;</span>
      macro in explanation strings. Defaults to the system's configured host
      name.</dd>
  <dt id="dns_resolver"><a class="permalink" href="#dns_resolver"><b>dns_resolver</b></a></dt>
  <dd>An optional DNS resolver object. If none is specified, a new
      <i>Net::DNS::Resolver</i> object is used. The resolver object may be of a
      different class, but it must provide an interface similar to
      <i>Net::DNS::Resolver</i> -- at least the
      <span class="Li">&quot;send&quot;</span> and
      <span class="Li">&quot;errorstring&quot;</span> methods must be supported,
      and the <span class="Li">&quot;send&quot;</span> method must return either
      an object of class <i>Net::DNS::Packet</i>, or, in the case of an error,
      <b>undef</b>.</dd>
  <dt id="query_rr_types"><a class="permalink" href="#query_rr_types"><b>query_rr_types</b></a></dt>
  <dd>For which RR types to query when looking up and selecting SPF records. The
      following values are supported:</dd>
</dl>
<div class="Bd-indent">
<dl class="Bl-tag">
  <dt id="Mail::SPF::Server"><a class="permalink" href="#Mail::SPF::Server"><b>Mail::SPF::Server-&gt;query_rr_type_all</b></a></dt>
  <dd>Both <span class="Li">&quot;TXT&quot;</span> and
      <span class="Li">&quot;SPF&quot;</span> type RRs.</dd>
  <dt id="Mail::SPF::Server~2"><a class="permalink" href="#Mail::SPF::Server~2"><b>Mail::SPF::Server-&gt;query_rr_type_txt</b>
    (default)</a></dt>
  <dd><span class="Li">&quot;TXT&quot;</span> type RRs only.</dd>
  <dt id="Mail::SPF::Server~3"><a class="permalink" href="#Mail::SPF::Server~3"><b>Mail::SPF::Server-&gt;query_rr_type_spf</b></a></dt>
  <dd><span class="Li">&quot;SPF&quot;</span> type RRs only.</dd>
</dl>
</div>
<div class="Bd-indent">
<p class="Pp">For years <b>Mail::SPF</b> has defaulted to looking up both
    <span class="Li">&quot;SPF&quot;</span> and
    <span class="Li">&quot;TXT&quot;</span> type RRs as recommended by RFC 4408.
    Experience has shown, however, that a significant portion of name servers
    suffer from serious brain damage with regard to the handling of queries for
    RR types that are unknown to them, such as the
    <span class="Li">&quot;SPF&quot;</span> RR type. Consequently
    <b>Mail::SPF</b> now defaults to looking up only
    <span class="Li">&quot;TXT&quot;</span> type RRs. This may be overridden by
    setting the <b>query_rr_types</b> option.</p>
<p class="Pp">See RFC 4408, 3.1.1, for a discussion of the topic, as well as the
    description of the &quot;select_record&quot; method.</p>
</div>
<dl class="Bl-tag">
  <dt id="max_dns_interactive_terms"><a class="permalink" href="#max_dns_interactive_terms"><b>max_dns_interactive_terms</b></a></dt>
  <dd>An <i>integer</i> denoting the maximum number of terms (mechanisms and
      modifiers) per SPF check that perform DNS look-ups, as defined in RFC
      4408, 10.1, paragraph 6. If <b>undef</b> is specified, there is no limit
      on the number of such terms. Defaults to <b>10</b>, which is the value
      defined in RFC 4408.
    <p class="Pp">A value above the default is <i>strongly discouraged</i> for
        security reasons. A value below the default has implications with regard
        to the predictability of SPF results. Only deviate from the default if
        you know what you are doing!</p>
  </dd>
  <dt id="max_name_lookups_per_term"><a class="permalink" href="#max_name_lookups_per_term"><b>max_name_lookups_per_term</b></a></dt>
  <dd>An <i>integer</i> denoting the maximum number of DNS name look-ups per
      term (mechanism or modifier), as defined in RFC 4408, 10.1, paragraph 7.
      If <b>undef</b> is specified, there is no limit on the number of look-ups
      performed. Defaults to <b>10</b>, which is the value defined in RFC 4408.
    <p class="Pp">A value above the default is <i>strongly discouraged</i> for
        security reasons. A value below the default has implications with regard
        to the predictability of SPF results. Only deviate from the default if
        you know what you are doing!</p>
  </dd>
  <dt id="max_name_lookups_per_mx_mech"><a class="permalink" href="#max_name_lookups_per_mx_mech"><b>max_name_lookups_per_mx_mech</b></a></dt>
  <dd></dd>
  <dt id="max_name_lookups_per_ptr_mech"><a class="permalink" href="#max_name_lookups_per_ptr_mech"><b>max_name_lookups_per_ptr_mech</b></a></dt>
  <dd>An <i>integer</i> denoting the maximum number of DNS name look-ups per
      <b>mx</b> or <b>ptr</b> mechanism, respectively. Defaults to the value of
      the <span class="Li">&quot;max_name_lookups_per_term&quot;</span> option.
      See there for additional information and security notes.</dd>
  <dt id="max_void_dns_lookups"><a class="permalink" href="#max_void_dns_lookups"><b>max_void_dns_lookups</b></a></dt>
  <dd>An <i>integer</i> denoting the maximum number of &quot;void&quot; DNS
      look-ups per SPF check, i.e. the number of DNS look-ups that were caused
      by DNS-interactive terms and macros (as defined in RFC 4408, 10.1,
      paragraphs 6 and 7) and that are allowed to return an empty answer with
      RCODE 0 or RCODE 3 (<span class="Li">&quot;NXDOMAIN&quot;</span>) before
      processing is aborted with a <span class="Li">&quot;permerror&quot;</span>
      result. If <b>undef</b> is specified, there is no stricter limit on the
      number of void DNS look-ups beyond the usual processing limits. Defaults
      to <b>2</b>.
    <p class="Pp">Specifically, the DNS look-ups that are subject to this limit
        are those caused by the <span class="Li">&quot;a&quot;</span>,
        <span class="Li">&quot;mx&quot;</span>,
        <span class="Li">&quot;ptr&quot;</span>, and
        <span class="Li">&quot;exists&quot;</span> mechanisms and the
        <span class="Li">&quot;p&quot;</span> macro.</p>
    <p class="Pp">A value of <b>2</b> is likely to prevent effective DoS attacks
        against third-party victim domains. However, a definite limit may cause
        <span class="Li">&quot;permerror&quot;</span> results even with certain
        (overly complex) innocent sender policies where useful results would
        normally be returned.</p>
  </dd>
</dl>
</div>
<div class="Bd-indent"></div>
</section>
<section class="Ss">
<h2 class="Ss" id="Class_methods"><a class="permalink" href="#Class_methods">Class
  methods</a></h2>
<p class="Pp">The following class methods are provided:</p>
<dl class="Bl-tag">
  <dt id="result_class"><a class="permalink" href="#result_class"><b>result_class</b>:
    returns <i>class</i></a></dt>
  <dd></dd>
  <dt id="result_class($name)"><a class="permalink" href="#result_class($name)"><b>result_class($name)</b>:
    returns <i>class</i></a></dt>
  <dd>Returns a <i>Mail::SPF::Result</i> descendent class determined from the
      given result name via the server's inherent result base class, or returns
      the server's inherent result base class if no result name is given. This
      method may also be used as an instance method.
    <p class="Pp"><i>Note</i>: Do not write code invoking class methods on
        <i>literal</i> result class names as this would ignore any derivative
        result classes provided by <b>Mail::SPF</b> extension modules.</p>
  </dd>
  <dt id="throw_result($name,"><a class="permalink" href="#throw_result($name,"><b>throw_result($name,
    </b><span class="Li"><b>$request</b></span><b>)</b>: throws
    <i>Mail::SPF::Result</i></a></dt>
  <dd></dd>
  <dt id="throw_result($name,~2"><a class="permalink" href="#throw_result($name,~2"><b>throw_result($name,
    </b><span class="Li"><b>$request</b></span><b>,
    </b><span class="Li"><b>$text</b></span><b>)</b>: throws
    <i>Mail::SPF::Result</i></a></dt>
  <dd>Throws a <i>Mail::SPF::Result</i> descendant determined from the given
      result name via the server's inherent result base class, passing an
      optional result text and associating the given <i>Mail::SPF::Request</i>
      object with the result object. This method may also be used as an instance
      method.
    <p class="Pp"><i>Note</i>: Do not write code invoking
        <span class="Li">&quot;throw&quot;</span> on <i>literal</i> result class
        names as this would ignore any derivative result classes provided by
        <b>Mail::SPF</b> extension modules.</p>
  </dd>
</dl>
</section>
<section class="Ss">
<h2 class="Ss" id="Instance_methods"><a class="permalink" href="#Instance_methods">Instance
  methods</a></h2>
<p class="Pp">The following instance methods are provided:</p>
<dl class="Bl-tag">
  <dt id="process($request)"><a class="permalink" href="#process($request)"><b>process($request)</b>:
    returns <i>Mail::SPF::Result</i></a></dt>
  <dd>Processes the given <i>Mail::SPF::Request</i> object, queries the
      authoritative domain for an SPF sender policy (see the description of the
      &quot;select_record&quot; method), evaluates the policy with regard to the
      given identity and other request parameters, and returns a
      <i>Mail::SPF::Result</i> object denoting the result of the policy
      evaluation. See RFC 4408, 4, and RFC 4406, 4, for details.</dd>
  <dt id="select_record($request)"><a class="permalink" href="#select_record($request)"><b>select_record($request)</b>:
    returns <i>Mail::SPF::Record</i>; throws <i>Mail::SPF::EDNSError</i>,
    <i>Mail::SPF::ENoAcceptableRecord</i>,
    <i>Mail::SPF::ERedundantAcceptableRecords</i>,
    <i>Mail::SPF::ESyntaxError</i></a></dt>
  <dd>Queries the authority domain of the given <i>Mail::SPF::Request</i> object
      for SPF sender policy records and, if multiple records are available,
      selects the record of the highest acceptable record version that covers
      the requested scope.
    <p class="Pp">More precisely, the following algorithm is performed (assuming
        that both <span class="Li">&quot;TXT&quot;</span> and
        <span class="Li">&quot;SPF&quot;</span> RR types are being queried):</p>
  </dd>
</dl>
<div class="Bd-indent">
<dl class="Bl-tag">
  <dt>1.</dt>
  <dd>Determine the authority domain, the set of acceptable SPF record versions,
      and the identity scope from the given request object.</dd>
  <dt>2.</dt>
  <dd>Query the authority domain for SPF records of the
      <span class="Li">&quot;SPF&quot;</span> DNS RR type, discarding any
      records that are of an inacceptable version or do not cover the desired
      scope.
    <p class="Pp">If this yields no SPF records, query the authority domain for
        SPF records of the <span class="Li">&quot;TXT&quot;</span> DNS RR type,
        discarding any records that are of an inacceptable version or do not
        cover the desired scope.</p>
    <p class="Pp">If still no acceptable SPF records could be found, throw a
        <i>Mail::SPF::ENoAcceptableRecord</i> exception.</p>
  </dd>
  <dt>3.</dt>
  <dd>Discard all records but those of the highest acceptable version found.
    <p class="Pp">If exactly one record remains, return it. Otherwise, throw a
        <i>Mail::SPF::ERedundantAcceptableRecords</i> exception.</p>
  </dd>
</dl>
</div>
<div class="Bd-indent">
<p class="Pp">If the querying of either RR type has been disabled via the
    &quot;new&quot; constructor's
    <span class="Li">&quot;query_rr_types&quot;</span> option, the respective
    part in step 2 will be skipped.</p>
<p class="Pp"><i>Mail::SPF::EDNSError</i> exceptions due to DNS look-ups and
    <i>Mail::SPF::ESyntaxError</i> exceptions due to invalid acceptable records
    may also be thrown.</p>
</div>
<dl class="Bl-tag">
  <dt id="get_acceptable_records_from_packet($packet,"><a class="permalink" href="#get_acceptable_records_from_packet($packet,"><b>get_acceptable_records_from_packet($packet,
    </b><span class="Li"><b>$rr_type</b></span><b>, \@versions,
    </b><span class="Li"><b>$scope</b></span><b>,
    </b><span class="Li"><b>$domain</b></span><b>)</b>: returns <i>list</i> of
    <i>Mail::SPF::Record</i></a></dt>
  <dd>Filters from the given <i>Net::DNS::Packet</i> object all resource records
      of the given RR type and for the given domain name, discarding any records
      that are not SPF records at all, that are of an inacceptable SPF record
      version, or that do not cover the given scope. Returns a list of
      acceptable records.</dd>
  <dt id="dns_lookup($domain,"><a class="permalink" href="#dns_lookup($domain,"><b>dns_lookup($domain,
    </b><span class="Li"><b>$rr_type</b></span><b>)</b>: returns
    <i>Net::DNS::Packet</i>; throws <i>Mail::SPF::EDNSTimeout</i>,
    <i>Mail::SPF::EDNSError</i></a></dt>
  <dd>Queries the DNS using the configured resolver for resource records of the
      desired type at the specified domain and returns a <i>Net::DNS::Packet</i>
      object if an answer packet was received. Throws a
      <i>Mail::SPF::EDNSTimeout</i> exception if a DNS time-out occurred. Throws
      a <i>Mail::SPF::EDNSError</i> exception if an error (other than RCODE 3
      AKA <span class="Li">&quot;NXDOMAIN&quot;</span>) occurred.</dd>
  <dt id="count_dns_interactive_term($request)"><a class="permalink" href="#count_dns_interactive_term($request)"><b>count_dns_interactive_term($request)</b>:
    throws <i>Mail::SPF::EProcessingLimitExceeded</i></a></dt>
  <dd>Increments by one the count of DNS-interactive mechanisms and modifiers
      that have been processed so far during the evaluation of the given
      <i>Mail::SPF::Request</i> object. If this exceeds the configured limit
      (see the &quot;new&quot; constructor's
      <span class="Li">&quot;max_dns_interactive_terms&quot;</span> option),
      throws a <i>Mail::SPF::EProcessingLimitExceeded</i> exception.
    <p class="Pp">This method is supposed to be called by the
        <span class="Li">&quot;match&quot;</span> and
        <span class="Li">&quot;process&quot;</span> methods of
        <i>Mail::SPF::Mech</i> and <i>Mail::SPF::Mod</i> sub-classes before (and
        only if) they do any DNS look-ups.</p>
  </dd>
  <dt id="count_void_dns_lookup($request)"><a class="permalink" href="#count_void_dns_lookup($request)"><b>count_void_dns_lookup($request)</b>:
    throws <i>Mail::SPF::EProcessingLimitExceeded</i></a></dt>
  <dd>Increments by one the count of &quot;void&quot; DNS look-ups that have
      occurred so far during the evaluation of the given
      <i>Mail::SPF::Request</i> object. If this exceeds the configured limit
      (see the &quot;new&quot; constructor's
      <span class="Li">&quot;max_void_dns_lookups&quot;</span> option), throws a
      <i>Mail::SPF::EProcessingLimitExceeded</i> exception.
    <p class="Pp">This method is supposed to be called by any code after any
        calls to the &quot;dns_lookup&quot; method whenever (i) no answer
        records were returned, and (ii) this fact is a possible indication of a
        DoS attack against a third-party victim domain, and (iii) the number of
        &quot;void&quot; look-ups is not already constrained otherwise (as for
        example is the case with the <span class="Li">&quot;include&quot;</span>
        mechanism and the <span class="Li">&quot;redirect&quot;</span>
        modifier). Specifically, this applies to look-ups performed by the
        <span class="Li">&quot;a&quot;</span>,
        <span class="Li">&quot;mx&quot;</span>,
        <span class="Li">&quot;ptr&quot;</span>, and
        <span class="Li">&quot;exists&quot;</span> mechanisms and the
        <span class="Li">&quot;p&quot;</span> macro.</p>
  </dd>
  <dt id="default_authority_explanation~2"><a class="permalink" href="#default_authority_explanation~2"><b>default_authority_explanation</b>:
    returns <i>Mail::SPF::MacroString</i></a></dt>
  <dd>Returns the default authority explanation as a <i>MacroString</i> object.
      See the description of the &quot;new&quot; constructor's
      <span class="Li">&quot;default_authority_explanation&quot;</span>
    option.</dd>
  <dt id="hostname~2"><a class="permalink" href="#hostname~2"><b>hostname</b>:
    returns <i>string</i></a></dt>
  <dd>Returns the local system's host name. See the description of the
      &quot;new&quot; constructor's <span class="Li">&quot;hostname&quot;</span>
      option.</dd>
  <dt id="dns_resolver~2"><a class="permalink" href="#dns_resolver~2"><b>dns_resolver</b>:
    returns <i>Net::DNS::Resolver</i> or compatible object</a></dt>
  <dd>Returns the DNS resolver object of the server object. See the description
      of the &quot;new&quot; constructor's
      <span class="Li">&quot;dns_resolver&quot;</span> option.</dd>
  <dt id="query_rr_types~2"><a class="permalink" href="#query_rr_types~2"><b>query_rr_types</b>:
    returns <i>integer</i></a></dt>
  <dd>Returns a value denoting the RR types for which to query when looking up
      and selecting SPF records. See the description of the &quot;new&quot;
      constructor's <span class="Li">&quot;query_rr_types&quot;</span>
    option.</dd>
  <dt id="max_dns_interactive_terms~2"><a class="permalink" href="#max_dns_interactive_terms~2"><b>max_dns_interactive_terms</b>:
    returns <i>integer</i></a></dt>
  <dd></dd>
  <dt id="max_name_lookups_per_term~2"><a class="permalink" href="#max_name_lookups_per_term~2"><b>max_name_lookups_per_term</b>:
    returns <i>integer</i></a></dt>
  <dd></dd>
  <dt id="max_name_lookups_per_mx_mech~2"><a class="permalink" href="#max_name_lookups_per_mx_mech~2"><b>max_name_lookups_per_mx_mech</b>:
    returns <i>integer</i></a></dt>
  <dd></dd>
  <dt id="max_name_lookups_per_ptr_mech~2"><a class="permalink" href="#max_name_lookups_per_ptr_mech~2"><b>max_name_lookups_per_ptr_mech</b>:
    returns <i>integer</i></a></dt>
  <dd></dd>
  <dt id="max_void_dns_lookups~2"><a class="permalink" href="#max_void_dns_lookups~2"><b>max_void_dns_lookups</b>:
    returns <i>integer</i></a></dt>
  <dd>Return the limit values of the server object. See the description of the
      &quot;new&quot; constructor's corresponding options.</dd>
</dl>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="SEE_ALSO"><a class="permalink" href="#SEE_ALSO">SEE
  ALSO</a></h1>
<p class="Pp">Mail::SPF, Mail::SPF::Request, Mail::SPF::Result</p>
<p class="Pp">&lt;http://tools.ietf.org/html/rfc4408&gt;</p>
<p class="Pp">For availability, support, and license information, see the README
    file included with Mail::SPF.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="AUTHORS"><a class="permalink" href="#AUTHORS">AUTHORS</a></h1>
<p class="Pp">Julian Mehnle &lt;julian@mehnle.net&gt;, Shevek
    &lt;cpan@anarres.org&gt;</p>
</section>
</div>
<table class="foot">
  <tr>
    <td class="foot-date">2023-05-20</td>
    <td class="foot-os">perl v5.34.0</td>
  </tr>
</table>
</body>
</html>
