<!DOCTYPE html>
<html>
<!-- This is an automatically generated file.  Do not edit.
  	$NetBSD: setkey.8,v 1.17 2005/09/15 08:42:09 wiz Exp $
  
   Copyright (C) 1995, 1996, 1997, 1998, and 1999 WIDE Project.
   All rights reserved.
  
   Redistribution and use in source and binary forms, with or without
   modification, are permitted provided that the following conditions
   are met:
   1. Redistributions of source code must retain the above copyright
      notice, this list of conditions and the following disclaimer.
   2. Redistributions in binary form must reproduce the above copyright
      notice, this list of conditions and the following disclaimer in the
      documentation and/or other materials provided with the distribution.
   3. Neither the name of the project nor the names of its contributors
      may be used to endorse or promote products derived from this software
      without specific prior written permission.
  
   THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS ``AS IS'' AND
   ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
   IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
   ARE DISCLAIMED.  IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE
   FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
   DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
   OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
   HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
   LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
   OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
   SUCH DAMAGE.
   -->
<head>

<style>
@media (prefers-color-scheme: dark) {
  body {
    background: #000;
    color: #d0d0d0;
  }

  a, a:visited {
    color: #1899eb;
  }
}
</style>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    table.head, table.foot { width: 100%; }
    td.head-rtitle, td.foot-os { text-align: right; }
    td.head-vol { text-align: center; }
    .Nd, .Bf, .Op { display: inline; }
    .Pa, .Ad { font-style: italic; }
    .Ms { font-weight: bold; }
    .Bl-diag > dt { font-weight: bold; }
    code.Nm, .Fl, .Cm, .Ic, code.In, .Fd, .Fn, .Cd { font-weight: bold;
      font-family: inherit; }
  </style>
  <title>SETKEY(8)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">SETKEY(8)</td>
    <td class="head-vol">System Manager's Manual</td>
    <td class="head-rtitle">SETKEY(8)</td>
  </tr>
</table>
<div class="manual-text">
<section class="Sh">
<h1 class="Sh" id="NAME"><a class="permalink" href="#NAME">NAME</a></h1>
<p class="Pp"><code class="Nm">setkey</code> &#x2014; <span class="Nd">manually
    manipulate the IPsec SA/SP database</span></p>
</section>
<section class="Sh">
<h1 class="Sh" id="SYNOPSIS"><a class="permalink" href="#SYNOPSIS">SYNOPSIS</a></h1>
<table class="Nm">
  <tr>
    <td><code class="Nm">setkey</code></td>
    <td>[<code class="Fl">-knrv</code>] <var class="Ar">file ...</var></td>
  </tr>
</table>
<br/>
<table class="Nm">
  <tr>
    <td><code class="Nm">setkey</code></td>
    <td>[<code class="Fl">-knrv</code>] <code class="Fl">-c</code></td>
  </tr>
</table>
<br/>
<table class="Nm">
  <tr>
    <td><code class="Nm">setkey</code></td>
    <td>[<code class="Fl">-krv</code>] <code class="Fl">-f</code>
      <var class="Ar">filename</var></td>
  </tr>
</table>
<br/>
<table class="Nm">
  <tr>
    <td><code class="Nm">setkey</code></td>
    <td>[<code class="Fl">-aklPrv</code>] <code class="Fl">-D</code></td>
  </tr>
</table>
<br/>
<table class="Nm">
  <tr>
    <td><code class="Nm">setkey</code></td>
    <td>[<code class="Fl">-Pvp</code>] <code class="Fl">-F</code></td>
  </tr>
</table>
<br/>
<table class="Nm">
  <tr>
    <td><code class="Nm">setkey</code></td>
    <td>[<code class="Fl">-H</code>] <code class="Fl">-x</code></td>
  </tr>
</table>
<br/>
<table class="Nm">
  <tr>
    <td><code class="Nm">setkey</code></td>
    <td>[<code class="Fl">-?V</code>]</td>
  </tr>
</table>
</section>
<section class="Sh">
<h1 class="Sh" id="DESCRIPTION"><a class="permalink" href="#DESCRIPTION">DESCRIPTION</a></h1>
<p class="Pp"><code class="Nm">setkey</code> adds, updates, dumps, or flushes
    Security Association Database (SAD) entries as well as Security Policy
    Database (SPD) entries in the kernel.</p>
<p class="Pp"><code class="Nm">setkey</code> takes a series of operations from
    standard input (if invoked with <code class="Fl">-c</code>) or the file
    named <var class="Ar">filename</var> (if invoked with
    <code class="Fl">-f</code> <var class="Ar">filename</var>).</p>
<dl class="Bl-tag">
  <dt>(no flag)</dt>
  <dd>Dump the SAD entries or SPD entries contained in the specified
      <var class="Ar">file</var>.</dd>
  <dt><code class="Fl">-</code>?</dt>
  <dd>Print short help.</dd>
  <dt id="a"><a class="permalink" href="#a"><code class="Fl">-a</code></a></dt>
  <dd><code class="Nm">setkey</code> usually does not display dead SAD entries
      with <code class="Fl">-D</code>. If <code class="Fl">-a</code> is also
      specified, the dead SAD entries will be displayed as well. A dead SAD
      entry is one that has expired but remains in the system because it is
      referenced by some SPD entries.</dd>
  <dt id="D"><a class="permalink" href="#D"><code class="Fl">-D</code></a></dt>
  <dd>Dump the SAD entries. If <code class="Fl">-P</code> is also specified, the
      SPD entries are dumped. If <code class="Fl">-p</code> is specified, the
      ports are displayed.</dd>
  <dt id="F"><a class="permalink" href="#F"><code class="Fl">-F</code></a></dt>
  <dd>Flush the SAD entries. If <code class="Fl">-P</code> is also specified,
      the SPD entries are flushed.</dd>
  <dt id="H"><a class="permalink" href="#H"><code class="Fl">-H</code></a></dt>
  <dd>Add hexadecimal dump in <code class="Fl">-x</code> mode.</dd>
  <dt id="h"><a class="permalink" href="#h"><code class="Fl">-h</code></a></dt>
  <dd>On <span class="Ux">NetBSD</span>, synonym for <code class="Fl">-H</code>.
      On other systems, synonym for <code class="Fl">-</code>?.</dd>
  <dt id="k"><a class="permalink" href="#k"><code class="Fl">-k</code></a></dt>
  <dd>Use semantics used in kernel. Available only in Linux. See also
      <code class="Fl">-r</code>.</dd>
  <dt id="l"><a class="permalink" href="#l"><code class="Fl">-l</code></a></dt>
  <dd>Loop forever with short output on <code class="Fl">-D</code>.</dd>
  <dt id="n"><a class="permalink" href="#n"><code class="Fl">-n</code></a></dt>
  <dd>No action. The program will check validity of the input, but no changes to
      the SPD will be made.</dd>
  <dt id="r"><a class="permalink" href="#r"><code class="Fl">-r</code></a></dt>
  <dd>Use semantics described in IPsec RFCs. This mode is default. For details
      see section <a class="Sx" href="#RFC_vs_Linux_kernel_semantics">RFC vs
      Linux kernel semantics</a>. Available only in Linux. See also
      <code class="Fl">-k</code>.</dd>
  <dt id="x"><a class="permalink" href="#x"><code class="Fl">-x</code></a></dt>
  <dd>Loop forever and dump all the messages transmitted to the
      <code class="Dv">PF_KEY</code> socket. <code class="Fl">-xx</code> prints
      the unformatted timestamps.</dd>
  <dt id="V"><a class="permalink" href="#V"><code class="Fl">-V</code></a></dt>
  <dd>Print version string.</dd>
  <dt id="v"><a class="permalink" href="#v"><code class="Fl">-v</code></a></dt>
  <dd>Be verbose. The program will dump messages exchanged on the
      <code class="Dv">PF_KEY</code> socket, including messages sent from other
      processes to the kernel.</dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="Configuration_syntax"><a class="permalink" href="#Configuration_syntax">Configuration
  syntax</a></h1>
<p class="Pp">With <code class="Fl">-c</code> or <code class="Fl">-f</code> on
    the command line, <code class="Nm">setkey</code> accepts the following
    configuration syntax. Lines starting with hash signs (&#x2018;#&#x2019;) are
    treated as comment lines.</p>
<dl class="Bl-tag">
  <dt id="add"><a class="permalink" href="#add"><code class="Li">add</code></a>
    [<code class="Fl">-46n</code>] <var class="Ar">src</var>
    <var class="Ar">dst</var> <var class="Ar">protocol</var>
    <var class="Ar">spi</var> [<var class="Ar">extensions</var>]
    <var class="Ar">algorithm ...</var> ;</dt>
  <dd>Add an SAD entry. <code class="Li">add</code> can fail for multiple
      reasons, including when the key length does not match the specified
      algorithm.</dd>
  <dt id="get"><a class="permalink" href="#get"><code class="Li">get</code></a>
    [<code class="Fl">-46n</code>] <var class="Ar">src</var>
    <var class="Ar">dst</var> <var class="Ar">protocol</var>
    <var class="Ar">spi</var> ;</dt>
  <dd>Show an SAD entry.</dd>
  <dt id="delete"><a class="permalink" href="#delete"><code class="Li">delete</code></a>
    [<code class="Fl">-46n</code>] <var class="Ar">src</var>
    <var class="Ar">dst</var> <var class="Ar">protocol</var>
    <var class="Ar">spi</var> ;</dt>
  <dd>Remove an SAD entry.</dd>
  <dt id="deleteall"><a class="permalink" href="#deleteall"><code class="Li">deleteall</code></a>
    [<code class="Fl">-46n</code>] <var class="Ar">src</var>
    <var class="Ar">dst</var> <var class="Ar">protocol</var> ;</dt>
  <dd>Remove all SAD entries that match the specification.</dd>
  <dt id="flush"><a class="permalink" href="#flush"><code class="Li">flush</code></a>
    [<var class="Ar">protocol</var>] ;</dt>
  <dd>Clear all SAD entries matched by the options. <code class="Fl">-F</code>
      on the command line achieves the same functionality.</dd>
  <dt id="dump"><a class="permalink" href="#dump"><code class="Li">dump</code></a>
    [<var class="Ar">protocol</var>] ;</dt>
  <dd>Dumps all SAD entries matched by the options. <code class="Fl">-D</code>
      on the command line achieves the same functionality.</dd>
  <dt id="spdadd"><a class="permalink" href="#spdadd"><code class="Li">spdadd</code></a>
    [<code class="Fl">-46n</code>] <var class="Ar">src_range</var>
    <var class="Ar">dst_range</var> <var class="Ar">upperspec</var>
    <var class="Ar">policy</var> ;</dt>
  <dd>Add an SPD entry.</dd>
  <dt><code class="Li">spdadd tagged</code> <var class="Ar">tag</var>
    <var class="Ar">policy</var> ;</dt>
  <dd>Add an SPD entry based on a PF tag. <var class="Ar">tag</var> must be a
      string surrounded by double quotes.</dd>
  <dt id="spddelete"><a class="permalink" href="#spddelete"><code class="Li">spddelete</code></a>
    [<code class="Fl">-46n</code>] <var class="Ar">src_range</var>
    <var class="Ar">dst_range</var> <var class="Ar">upperspec</var>
    <code class="Fl">-P</code> <var class="Ar">direction</var> ;</dt>
  <dd>Delete an SPD entry.</dd>
  <dt id="spdflush"><a class="permalink" href="#spdflush"><code class="Li">spdflush</code></a>
    ;</dt>
  <dd>Clear all SPD entries. <code class="Fl">-FP</code> on the command line
      achieves the same functionality.</dd>
  <dt id="spddump"><a class="permalink" href="#spddump"><code class="Li">spddump</code></a>
    ;</dt>
  <dd>Dumps all SPD entries. <code class="Fl">-DP</code> on the command line
      achieves the same functionality.</dd>
</dl>
<p class="Pp">Meta-arguments are as follows:</p>
<p class="Pp"></p>
<dl class="Bl-tag Bl-compact">
  <dt><var class="Ar">src</var></dt>
  <dd style="width: auto;">&#x00A0;</dd>
  <dt><var class="Ar">dst</var></dt>
  <dd>Source/destination of the secure communication is specified as an IPv4/v6
      address, and an optional port number between square brackets.
      <code class="Nm">setkey</code> can resolve a FQDN into numeric addresses.
      If the FQDN resolves into multiple addresses,
      <code class="Nm">setkey</code> will install multiple SAD/SPD entries into
      the kernel by trying all possible combinations.
      <code class="Fl">-4</code>, <code class="Fl">-6</code>, and
      <code class="Fl">-n</code> restrict the address resolution of FQDN in
      certain ways. <code class="Fl">-4</code> and <code class="Fl">-6</code>
      restrict results into IPv4/v6 addresses only, respectively.
      <code class="Fl">-n</code> avoids FQDN resolution and requires addresses
      to be numeric addresses.
    <p class="Pp"></p>
  </dd>
  <dt><var class="Ar">protocol</var></dt>
  <dd><var class="Ar">protocol</var> is one of following:
    <dl class="Bl-tag Bl-compact">
      <dt id="esp"><a class="permalink" href="#esp"><code class="Li">esp</code></a></dt>
      <dd>ESP based on rfc2406</dd>
      <dt id="esp-old"><a class="permalink" href="#esp-old"><code class="Li">esp-old</code></a></dt>
      <dd>ESP based on rfc1827</dd>
      <dt id="ah"><a class="permalink" href="#ah"><code class="Li">ah</code></a></dt>
      <dd>AH based on rfc2402</dd>
      <dt id="ah-old"><a class="permalink" href="#ah-old"><code class="Li">ah-old</code></a></dt>
      <dd>AH based on rfc1826</dd>
      <dt id="ipcomp"><a class="permalink" href="#ipcomp"><code class="Li">ipcomp</code></a></dt>
      <dd>IPComp</dd>
      <dt id="tcp"><a class="permalink" href="#tcp"><code class="Li">tcp</code></a></dt>
      <dd>TCP-MD5 based on rfc2385</dd>
    </dl>
    <p class="Pp"></p>
  </dd>
  <dt><var class="Ar">spi</var></dt>
  <dd>Security Parameter Index (SPI) for the SAD and the SPD.
      <var class="Ar">spi</var> must be a decimal number, or a hexadecimal
      number with a &#x201C;<code class="Li">0x</code>&#x201D; prefix. SPI
      values between 0 and 255 are reserved for future use by IANA and cannot be
      used. TCP-MD5 associations must use 0x1000 and therefore only have
      per-host granularity at this time.
    <p class="Pp"></p>
  </dd>
  <dt><var class="Ar">extensions</var></dt>
  <dd>take some of the following:
    <dl class="Bl-tag Bl-compact">
      <dt id="m"><a class="permalink" href="#m"><code class="Fl">-m</code></a>
        <var class="Ar">mode</var></dt>
      <dd>Specify a security protocol mode for use. <var class="Ar">mode</var>
          is one of following: <code class="Li">transport</code>,
          <code class="Li">tunnel</code>, or <code class="Li">any</code>. The
          default value is <code class="Li">any</code>.</dd>
      <dt id="r~2"><a class="permalink" href="#r~2"><code class="Fl">-r</code></a>
        <var class="Ar">size</var></dt>
      <dd>Specify window size of bytes for replay prevention.
          <var class="Ar">size</var> must be decimal number in 32-bit word. If
          <var class="Ar">size</var> is zero or not specified, replay checks
          don't take place.</dd>
      <dt id="u"><a class="permalink" href="#u"><code class="Fl">-u</code></a>
        <var class="Ar">id</var></dt>
      <dd>Specify the identifier of the policy entry in the SPD. See
          <var class="Ar">policy</var>.</dd>
      <dt id="f"><a class="permalink" href="#f"><code class="Fl">-f</code></a>
        <var class="Ar">pad_option</var></dt>
      <dd>defines the content of the ESP padding.
          <var class="Ar">pad_option</var> is one of following:
        <dl class="Bl-tag Bl-compact">
          <dt id="zero-pad"><a class="permalink" href="#zero-pad"><code class="Li">zero-pad</code></a></dt>
          <dd>All the paddings are zero.</dd>
          <dt id="random-pad"><a class="permalink" href="#random-pad"><code class="Li">random-pad</code></a></dt>
          <dd>A series of randomized values are used.</dd>
          <dt id="seq-pad"><a class="permalink" href="#seq-pad"><code class="Li">seq-pad</code></a></dt>
          <dd>A series of sequential increasing numbers started from 1 are
            used.</dd>
        </dl>
      </dd>
      <dt id="f~2"><a class="permalink" href="#f~2"><code class="Fl">-f</code></a>
        <code class="Li">nocyclic-seq</code></dt>
      <dd>Don't allow cyclic sequence numbers.</dd>
      <dt id="lh"><a class="permalink" href="#lh"><code class="Fl">-lh</code></a>
        <var class="Ar">time</var></dt>
      <dd style="width: auto;">&#x00A0;</dd>
      <dt id="ls"><a class="permalink" href="#ls"><code class="Fl">-ls</code></a>
        <var class="Ar">time</var></dt>
      <dd>Specify hard/soft life time duration of the SA measured in
        seconds.</dd>
      <dt id="bh"><a class="permalink" href="#bh"><code class="Fl">-bh</code></a>
        <var class="Ar">bytes</var></dt>
      <dd style="width: auto;">&#x00A0;</dd>
      <dt id="bs"><a class="permalink" href="#bs"><code class="Fl">-bs</code></a>
        <var class="Ar">bytes</var></dt>
      <dd>Specify hard/soft life time duration of the SA measured in bytes
          transported.</dd>
    </dl>
    <p class="Pp"></p>
  </dd>
  <dt><var class="Ar">algorithm</var></dt>
  <dd>
    <dl class="Bl-tag Bl-compact">
      <dt id="E"><a class="permalink" href="#E"><code class="Fl">-E</code></a>
        <var class="Ar">ealgo</var> <var class="Ar">key</var></dt>
      <dd>Specify an encryption algorithm <var class="Ar">ealgo</var> for
        ESP.</dd>
      <dt id="E~2"><a class="permalink" href="#E~2"><code class="Fl">-E</code></a>
        <var class="Ar">ealgo</var> <var class="Ar">key</var>
        <code class="Fl">-A</code> <var class="Ar">aalgo</var>
        <var class="Ar">key</var></dt>
      <dd>Specify an encryption algorithm <var class="Ar">ealgo</var>, as well
          as a payload authentication algorithm <var class="Ar">aalgo</var>, for
          ESP.</dd>
      <dt id="A"><a class="permalink" href="#A"><code class="Fl">-A</code></a>
        <var class="Ar">aalgo</var> <var class="Ar">key</var></dt>
      <dd>Specify an authentication algorithm for AH.</dd>
      <dt id="C"><a class="permalink" href="#C"><code class="Fl">-C</code></a>
        <var class="Ar">calgo</var> [<code class="Fl">-R</code>]</dt>
      <dd>Specify a compression algorithm for IPComp. If
          <code class="Fl">-R</code> is specified, the <var class="Ar">spi</var>
          field value will be used as the IPComp CPI (compression parameter
          index) on wire as-is. If <code class="Fl">-R</code> is not specified,
          the kernel will use well-known CPI on wire, and
          <var class="Ar">spi</var> field will be used only as an index for
          kernel internal usage.</dd>
    </dl>
    <p class="Pp"><var class="Ar">key</var> must be a double-quoted character
        string, or a series of hexadecimal digits preceded by
        &#x201C;<code class="Li">0x</code>&#x201D;.</p>
    <p class="Pp">Possible values for <var class="Ar">ealgo</var>,
        <var class="Ar">aalgo</var>, and <var class="Ar">calgo</var> are
        specified in the <a class="Sx" href="#Algorithms">Algorithms</a>
        sections.</p>
    <p class="Pp"></p>
  </dd>
  <dt><var class="Ar">src_range</var></dt>
  <dd style="width: auto;">&#x00A0;</dd>
  <dt><var class="Ar">dst_range</var></dt>
  <dd>These select the communications that should be secured by IPsec. They can
      be an IPv4/v6 address or an IPv4/v6 address range, and may be accompanied
      by a TCP/UDP port specification. This takes the following form:
    <div class="Bd Pp Li">
    <pre><var class="Ar">address</var>
<var class="Ar">address/prefixlen</var>
<var class="Ar">address[port]</var>
<var class="Ar">address/prefixlen[port]</var></pre>
    </div>
    <p class="Pp"><var class="Ar">prefixlen</var> and <var class="Ar">port</var>
        must be a decimal number. The square brackets around
        <var class="Ar">port</var> are necessary and are not manpage
        metacharacters. For FQDN resolution, the rules applicable to
        <var class="Ar">src</var> and <var class="Ar">dst</var> apply here as
        well.</p>
    <p class="Pp"></p>
  </dd>
  <dt><var class="Ar">upperspec</var></dt>
  <dd>Upper-layer protocol to be used. You can use one of the words in
      <span class="Pa">/etc/protocols</span> as <var class="Ar">upperspec</var>,
      or <code class="Li">icmp6</code>, <code class="Li">ip4</code>, or
      <code class="Li">any</code>. <code class="Li">any</code> stands for
      &#x201C;any protocol&#x201D;. You can also use the protocol number. You
      can specify a type and/or a code of ICMPv6 when the upper-layer protocol
      is ICMPv6. The specification must be placed after
      <code class="Li">icmp6</code>. A type is separated from a code by single
      comma. A code must always be specified. When a zero is specified, the
      kernel deals with it as a wildcard. Note that the kernel can not
      distinguish a wildcard from an ICMPv6 type of zero. For example, the
      following means that the policy doesn't require IPsec for any inbound
      Neighbor Solicitation:
    <p class="Pp"></p>
    <div class="Bd Bd-indent"><code class="Li">spdadd ::/0 ::/0 icmp6 135,0 -P
      in none ;</code></div>
    <p class="Pp" id="NOTE:"><a class="permalink" href="#NOTE:"><i class="Em">NOTE:</i></a>
        <var class="Ar">upperspec</var> does not work against forwarding case at
        this moment, as it requires extra reassembly at the forwarding node
        (currently not implemented). There are many protocols in
        <span class="Pa">/etc/protocols</span>, protocols other than TCP, UDP,
        and ICMP may not be suitable to use with IPsec. You have to consider
        carefully what to use.</p>
    <p class="Pp"></p>
  </dd>
  <dt><var class="Ar">policy</var></dt>
  <dd><var class="Ar">policy</var> is in one of the following three formats:
    <p class="Pp"></p>
    <dl class="Bl-tag Bl-compact">
      <dt id="P"><a class="permalink" href="#P"><code class="Fl">-P</code></a>
        <var class="Ar">direction [priority specification]</var>
        <code class="Li">discard</code></dt>
      <dd style="width: auto;">&#x00A0;</dd>
      <dt id="P~2"><a class="permalink" href="#P~2"><code class="Fl">-P</code></a>
        <var class="Ar">direction [priority specification]</var>
        <code class="Li">none</code></dt>
      <dd style="width: auto;">&#x00A0;</dd>
      <dt id="P~3"><a class="permalink" href="#P~3"><code class="Fl">-P</code></a>
        <var class="Ar">direction [priority specification]</var>
        <code class="Li">ipsec</code>
        <var class="Ar">protocol/mode/src-dst/level</var> [...]</dt>
      <dd style="width: auto;">&#x00A0;</dd>
    </dl>
    <p class="Pp">You must specify the direction of its policy as
        <var class="Ar">direction</var>. Either <var class="Ar">out</var>,
        <var class="Ar">in</var>, or <var class="Ar">fwd</var> can be used.</p>
    <p class="Pp"><var class="Ar">priority specification</var> is used to
        control the placement of the policy within the SPD. Policy position is
        determined by a signed integer where higher priorities indicate the
        policy is placed closer to the beginning of the list and lower
        priorities indicate the policy is placed closer to the end of the list.
        Policies with equal priorities are added at the end of groups of such
        policies.</p>
    <p class="Pp">Priority can only be specified when setkey has been compiled
        against kernel headers that support policy priorities (Linux &gt;=
        2.6.6). If the kernel does not support priorities, a warning message
        will be printed the first time a priority specification is used. Policy
        priority takes one of the following formats:</p>
    <dl class="Bl-tag">
      <dt><var class="Ar">{priority,prio} offset</var></dt>
      <dd><var class="Ar">offset</var> is an integer in the range from
          -2147483647 to 214783648.</dd>
      <dt><var class="Ar">{priority,prio} base {+,-} offset</var></dt>
      <dd><var class="Ar">base</var> is either <code class="Li">low
          (-1073741824)</code>, <code class="Li">def (0)</code>, or
          <code class="Li">high (1073741824)</code>
        <p class="Pp"><var class="Ar">offset</var> is an unsigned integer. It
            can be up to 1073741824 for positive offsets, and up to 1073741823
            for negative offsets.</p>
      </dd>
    </dl>
    <p class="Pp"><code class="Li">discard</code> means the packet matching
        indexes will be discarded. <code class="Li">none</code> means that IPsec
        operation will not take place onto the packet.
        <code class="Li">ipsec</code> means that IPsec operation will take place
        onto the packet.</p>
    <p class="Pp">The <var class="Ar">protocol/mode/src-dst/level</var> part
        specifies the rule how to process the packet. Either
        <code class="Li">ah</code>, <code class="Li">esp</code>, or
        <code class="Li">ipcomp</code> must be used as
        <var class="Ar">protocol</var>. <var class="Ar">mode</var> is either
        <code class="Li">transport</code> or <code class="Li">tunnel</code>. If
        <var class="Ar">mode</var> is <code class="Li">tunnel</code>, you must
        specify the end-point addresses of the SA as <var class="Ar">src</var>
        and <var class="Ar">dst</var> with &#x2018;-&#x2019; between these
        addresses, which is used to specify the SA to use. If
        <var class="Ar">mode</var> is <code class="Li">transport</code>, both
        <var class="Ar">src</var> and <var class="Ar">dst</var> can be omitted.
        <var class="Ar">level</var> is to be one of the following:
        <code class="Li">default</code>, <code class="Li">use</code>,
        <code class="Li">require</code>, or <code class="Li">unique</code>. If
        the SA is not available in every level, the kernel will ask the key
        exchange daemon to establish a suitable SA.
        <code class="Li">default</code> means the kernel consults the system
        wide default for the protocol you specified, e.g. the
        <code class="Li">esp_trans_deflev</code> sysctl variable, when the
        kernel processes the packet. <code class="Li">use</code> means that the
        kernel uses an SA if it's available, otherwise the kernel keeps normal
        operation. <code class="Li">require</code> means SA is required whenever
        the kernel sends a packet matched with the policy.
        <code class="Li">unique</code> is the same as
        <code class="Li">require</code>; in addition, it allows the policy to
        match the unique out-bound SA. You just specify the policy level
        <code class="Li">unique</code>, <a class="Xr">racoon(8)</a> will
        configure the SA for the policy. If you configure the SA by manual
        keying for that policy, you can put a decimal number as the policy
        identifier after <code class="Li">unique</code> separated by a colon
        &#x2018;:&#x2019; like: <code class="Li">unique:number</code> in order
        to bind this policy to the SA. <code class="Li">number</code> must be
        between 1 and 32767. It corresponds to <var class="Ar">extensions</var>
        <code class="Fl">-u</code> of the manual SA configuration.</p>
    <p class="Pp">When you want to use an SA bundle, you can define multiple
        rules. For example, if an IP header was followed by an AH header
        followed by an ESP header followed by an upper layer protocol header,
        the rule would be:</p>
    <p class="Pp"></p>
    <div class="Bd Bd-indent"><code class="Li">esp/transport//require
      ah/transport//require</code></div>
    ;
    <p class="Pp">The rule order is very important.</p>
    <p class="Pp">When NAT-T is enabled in the kernel, policy matching for ESP
        over UDP packets may be done on endpoint addresses and port (this
        depends on the system. System that do not perform the port check cannot
        support multiple endpoints behind the same NAT). When using ESP over
        UDP, you can specify port numbers in the endpoint addresses to get the
        correct matching. Here is an example:</p>
    <div class="Bd Pp Li">
    <pre>spdadd 10.0.11.0/24[any] 10.0.11.33/32[any] any -P out ipsec
    esp/tunnel/192.168.0.1[4500]-192.168.1.2[30000]/require ;

    </pre>
    </div>
    These ports must be left unspecified (which defaults to 0) for anything
      other than ESP over UDP. They can be displayed in SPD dump using
      <code class="Nm">setkey</code> <code class="Fl">-DPp</code>.
    <p class="Pp">Note that &#x201C;<code class="Li">discard</code>&#x201D; and
        &#x201C;<code class="Li">none</code>&#x201D; are not in the syntax
        described in <a class="Xr">ipsec_set_policy(3)</a>. There are a few
        differences in the syntax. See <a class="Xr">ipsec_set_policy(3)</a> for
        detail.</p>
  </dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="Algorithms"><a class="permalink" href="#Algorithms">Algorithms</a></h1>
<p class="Pp">The following list shows the supported algorithms.
    <a class="permalink" href="#protocol"><b class="Sy" id="protocol">protocol</b></a>
    and
    <a class="permalink" href="#algorithm"><b class="Sy" id="algorithm">algorithm</b></a>
    are almost orthogonal. These authentication algorithms can be used as
    <var class="Ar">aalgo</var> in <code class="Fl">-A</code>
    <var class="Ar">aalgo</var> of the <var class="Ar">protocol</var>
  parameter:</p>
<div class="Bd Pp Bd-indent Li">
<pre>algorithm	keylen (bits)   comment
hmac-md5	128		ah: rfc2403
		128		ah-old: rfc2085
hmac-sha1	160		ah: rfc2404
		160		ah-old: 128bit ICV (no document)
keyed-md5	128		ah: 96bit ICV (no document)
		128		ah-old: rfc1828
keyed-sha1	160		ah: 96bit ICV (no document)
		160		ah-old: 128bit ICV (no document)
null		0 to 2048	for debugging
hmac-sha256	256		ah: 96bit ICV
				(draft-ietf-ipsec-ciph-sha-256-00)
		256		ah-old: 128bit ICV (no document)
hmac-sha384	384		ah: 96bit ICV (no document)
		384		ah-old: 128bit ICV (no document)
hmac-sha512	512		ah: 96bit ICV (no document)
		512		ah-old: 128bit ICV (no document)
hmac-ripemd160	160		ah: 96bit ICV (RFC2857)
				ah-old: 128bit ICV (no document)
aes-xcbc-mac	128		ah: 96bit ICV (RFC3566)
		128		ah-old: 128bit ICV (no document)
tcp-md5		8 to 640	tcp: rfc2385</pre>
</div>
<p class="Pp">These encryption algorithms can be used as
    <var class="Ar">ealgo</var> in <code class="Fl">-E</code>
    <var class="Ar">ealgo</var> of the <var class="Ar">protocol</var>
  parameter:</p>
<div class="Bd Pp Bd-indent Li">
<pre>algorithm	keylen (bits)   comment
des-cbc		64		esp-old: rfc1829, esp: rfc2405
3des-cbc	192		rfc2451
null		0 to 2048	rfc2410
blowfish-cbc	40 to 448	rfc2451
cast128-cbc	40 to 128	rfc2451
des-deriv	64		ipsec-ciph-des-derived-01
3des-deriv	192		no document
rijndael-cbc	128/192/256	rfc3602
twofish-cbc	0 to 256	draft-ietf-ipsec-ciph-aes-cbc-01
aes-ctr		160/224/288	draft-ietf-ipsec-ciph-aes-ctr-03</pre>
</div>
<p class="Pp">Note that the first 128 bits of a key for
    <code class="Li">aes-ctr</code> will be used as AES key, and the remaining
    32 bits will be used as nonce.</p>
<p class="Pp">These compression algorithms can be used as
    <var class="Ar">calgo</var> in <code class="Fl">-C</code>
    <var class="Ar">calgo</var> of the <var class="Ar">protocol</var>
  parameter:</p>
<div class="Bd Pp Bd-indent Li">
<pre>algorithm   comment
deflate		rfc2394</pre>
</div>
</section>
<section class="Sh">
<h1 class="Sh" id="RFC_vs_Linux_kernel_semantics"><a class="permalink" href="#RFC_vs_Linux_kernel_semantics">RFC
  vs Linux kernel semantics</a></h1>
<p class="Pp">The Linux kernel uses the <var class="Ar">fwd</var> policy instead
    of the <var class="Ar">in</var> policy for packets what are forwarded
    through that particular box.</p>
<p class="Pp">In <var class="Ar">kernel</var> mode,
    <code class="Nm">setkey</code> manages and shows policies and SAs exactly as
    they are stored in the kernel.</p>
<p class="Pp">In <var class="Ar">RFC</var> mode, <code class="Nm">setkey</code>
    creates <var class="Ar">fwd</var> policies for every
    <var class="Ar">in</var> policy inserted
  <br/>
  (not implemented yet) filters out all <var class="Ar">fwd</var> policies</p>
</section>
<section class="Sh">
<h1 class="Sh" id="RETURN_VALUES"><a class="permalink" href="#RETURN_VALUES">RETURN
  VALUES</a></h1>
<p class="Pp">The command exits with 0 on success, and non-zero on errors.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="EXAMPLES"><a class="permalink" href="#EXAMPLES">EXAMPLES</a></h1>
<div class="Bd Li">
<pre>add 3ffe:501:4819::1 3ffe:501:481d::1 esp 123457
	-E des-cbc 0x3ffe05014819ffff ;

add -6 myhost.example.com yourhost.example.com ah 123456
	-A hmac-sha1 &quot;AH SA configuration!&quot; ;

add 10.0.11.41 10.0.11.33 esp 0x10001
	-E des-cbc 0x3ffe05014819ffff
	-A hmac-md5 &quot;authentication!!&quot; ;

get 3ffe:501:4819::1 3ffe:501:481d::1 ah 123456 ;

flush ;

dump esp ;

spdadd 10.0.11.41/32[21] 10.0.11.33/32[any] any
	-P out ipsec esp/tunnel/192.168.0.1-192.168.1.2/require ;

add 10.1.10.34 10.1.10.36 tcp 0x1000 -A tcp-md5 &quot;TCP-MD5 BGP secret&quot; ;</pre>
</div>
</section>
<section class="Sh">
<h1 class="Sh" id="SEE_ALSO"><a class="permalink" href="#SEE_ALSO">SEE
  ALSO</a></h1>
<p class="Pp"><a class="Xr">ipsec_set_policy(3)</a>,
    <a class="Xr">racoon(8)</a>, <a class="Xr">sysctl(8)</a></p>
<p class="Pp"><cite class="Rs"><span class="RsT">Changed manual key
    configuration for IPsec</span>, <span class="RsD">October 1999</span>,
    <span class="RsO">http://www.kame.net/newsletter/19991007/</span>.</cite></p>
</section>
<section class="Sh">
<h1 class="Sh" id="HISTORY"><a class="permalink" href="#HISTORY">HISTORY</a></h1>
<p class="Pp">The <code class="Nm">setkey</code> command first appeared in the
    WIDE Hydrangea IPv6 protocol stack kit. The command was completely
    re-designed in June 1998.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="BUGS"><a class="permalink" href="#BUGS">BUGS</a></h1>
<p class="Pp"><code class="Nm">setkey</code> should report and handle syntax
    errors better.</p>
<p class="Pp">For IPsec gateway configuration, <var class="Ar">src_range</var>
    and <var class="Ar">dst_range</var> with TCP/UDP port numbers does not work,
    as the gateway does not reassemble packets (it cannot inspect upper-layer
    headers).</p>
</section>
</div>
<table class="foot">
  <tr>
    <td class="foot-date">March 19, 2004</td>
    <td class="foot-os">Mac OS X 12</td>
  </tr>
</table>
</body>
</html>
