<!DOCTYPE html>
<html>
<!-- This is an automatically generated file.  Do not edit.
   Automatically generated by Pod::Man 2.27 (Pod::Simple 3.28)
  
   Standard preamble:
   ========================================================================
   Vertical space (when we can't use .PP)
   Begin verbatim text
   End verbatim text
   Set up some character translations and predefined strings.  \*(-- will
   give an unbreakable dash, \*(PI will give pi, \*(L" will give a left
   double quote, and \*(R" will give a right double quote.  \*(C+ will
   give a nicer C++.  Capital omega is used to do unbreakable dashes and
   therefore won't be available.  \*(C` and \*(C' expand to `' in nroff,
   nothing in troff, for use with C<>.
   diablo 10 pitch
    diablo 12 pitch
 -->
<head>
  <meta charset="utf-8"/>
  <style>
    table.head, table.foot { width: 100%; }
    td.head-rtitle, td.foot-os { text-align: right; }
    td.head-vol { text-align: center; }
    div.Pp { margin: 1ex 0ex; }
    div.Nd, div.Bf, div.Op { display: inline; }
    span.Pa, span.Ad { font-style: italic; }
    span.Ms { font-weight: bold; }
    dl.Bl-diag > dt { font-weight: bold; }
    code.Nm, code.Fl, code.Cm, code.Ic, code.In, code.Fd, code.Fn,
    code.Cd { font-weight: bold; font-family: inherit; }
  </style>
  <title>Moose::Cookbook::Meta::PrivateOrPublic_MethodMetaclass(3)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">Moose::Cookbook::Meta::PrivateOrPublic_MethodMetaclass(3)</td>
    <td class="head-vol">User Contributed Perl Documentation</td>
    <td class="head-rtitle">Moose::Cookbook::Meta::PrivateOrPublic_MethodMetaclass(3)</td>
  </tr>
</table>
<div class="manual-text">
<br/>
<section class="Sh">
<h1 class="Sh" id="NAME"><a class="permalink" href="#NAME">NAME</a></h1>
Moose::Cookbook::Meta::PrivateOrPublic_MethodMetaclass - A method metaclass for
  marking methods public or private
</section>
<section class="Sh">
<h1 class="Sh" id="VERSION"><a class="permalink" href="#VERSION">VERSION</a></h1>
version 2.1202
</section>
<section class="Sh">
<h1 class="Sh" id="SYNOPSIS"><a class="permalink" href="#SYNOPSIS">SYNOPSIS</a></h1>
<span class="Li"></span>
<pre>
  package MyApp::Meta::Method::PrivateOrPublic;

  use Moose;
  use Moose::Util::TypeConstraints;

  extends 'Moose::Meta::Method';

  has '_policy' =&gt; (
      is       =&gt; 'ro',
      isa      =&gt; enum( [ qw( public private ) ] ),
      default  =&gt; 'public',
      init_arg =&gt; 'policy',
  );

  sub new {
      my $class   = shift;
      my %options = @_;

      my $self = $class-&gt;SUPER::wrap(%options);

      $self-&gt;{_policy} = $options{policy};

      $self-&gt;_add_policy_wrapper;

      return $self;
  }

  sub _add_policy_wrapper {
      my $self = shift;

      return if $self-&gt;is_public;

      my $name      = $self-&gt;name;
      my $package   = $self-&gt;package_name;
      my $real_body = $self-&gt;body;

      my $body = sub {
          die &quot;The $package\::$name method is private&quot;
              unless ( scalar caller() ) eq $package;

          goto &amp;{$real_body};
      };

      $self-&gt;{body} = $body;
  }

  sub is_public  { $_[0]-&gt;_policy eq 'public' }
  sub is_private { $_[0]-&gt;_policy eq 'private' }

  package MyApp::User;

  use Moose;

  has 'password' =&gt; ( is =&gt; 'rw' );

  __PACKAGE__-&gt;meta()-&gt;add_method(
      '_reset_password',
      MyApp::Meta::Method::PrivateOrPublic-&gt;new(
          name         =&gt; '_reset_password',
          package_name =&gt; __PACKAGE__,
          body         =&gt; sub { $_[0]-&gt;password('reset') },
          policy       =&gt; 'private',
      )
  );
</pre>
</section>
<section class="Sh">
<h1 class="Sh" id="DESCRIPTION"><a class="permalink" href="#DESCRIPTION">DESCRIPTION</a></h1>
This example shows a custom method metaclass that models public versus private
  methods. If a method is defined as private, it adds a wrapper around the
  method which dies unless it is called from the class where it was defined.
<p class="Pp">The way the method is added to the class is rather ugly. If we
    wanted to make this a real feature, we'd probably want to add some sort of
    sugar to allow us to declare private methods, but that is beyond the scope
    of this recipe. See the Extending recipes for more on this topic.</p>
<p class="Pp">The core of our custom class is the
    <span class="Li">&quot;policy&quot;</span> attribute, and
    <span class="Li">&quot;_add_policy_wrapper&quot;</span> method.</p>
<p class="Pp">You'll note that we have to explicitly set the
    <span class="Li">&quot;policy&quot;</span> attribute in our constructor:</p>
<p class="Pp"><span class="Li"></span></p>
<pre>
      $self-&gt;{_policy} = $options{policy};
</pre>
<p class="Pp">That is necessary because Moose metaclasses do not use the meta
    API to create objects. Most Moose classes have a custom &quot;inlined&quot;
    constructor for speed.</p>
<p class="Pp">In this particular case, our parent class's constructor is the
    <span class="Li">&quot;wrap&quot;</span> method. We call that to build our
    object, but it does not include subclass-specific attributes.</p>
<p class="Pp">The <span class="Li">&quot;_add_policy_wrapper&quot;</span> method
    is where the real work is done. If the method is private, we construct a
    wrapper around the real subroutine which checks that the caller matches the
    package in which the subroutine was created.</p>
<p class="Pp">If they don't match, it dies. If they do match, the real method is
    called. We use <span class="Li">&quot;goto&quot;</span> so that the wrapper
    does not show up in the call stack.</p>
<p class="Pp">Finally, we replace the value of
    <span class="Li">&quot;$self-&gt;{body}&quot;</span>. This is another case
    where we have to do something a bit gross because Moose does not use Moose
    for its own implementation.</p>
<p class="Pp">When we pass this method object to the metaclass's
    <span class="Li">&quot;add_method&quot;</span> method, it will take the
    method body and make it available in the class.</p>
<p class="Pp">Finally, when we retrieve these methods via the introspection API,
    we can call the <span class="Li">&quot;is_public&quot;</span> and
    <span class="Li">&quot;is_private&quot;</span> methods on them to get more
    information about the method.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="SUMMARY"><a class="permalink" href="#SUMMARY">SUMMARY</a></h1>
A custom method metaclass lets us add both behavior and meta-information to
  methods. Unfortunately, because the Perl interpreter does not provide easy
  hooks into method declaration, the API we have for adding these methods is not
  very pretty.
<p class="Pp">That can be improved with custom Moose-like sugar, or even by
    using a tool like Devel::Declare to create full-blown new keywords in
  Perl.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="AUTHORS"><a class="permalink" href="#AUTHORS">AUTHORS</a></h1>
<ul class="Bl-bullet">
  <li>Stevan Little &lt;stevan.little@iinteractive.com&gt;</li>
  <li>Dave Rolsky &lt;autarch@urth.org&gt;</li>
  <li>Jesse Luehrs &lt;doy@tozt.net&gt;</li>
  <li>Shawn M Moore &lt;code@sartak.org&gt;</li>
  <li>XXXX XXX'XX (Yuval Kogman) &lt;nothingmuch@woobling.org&gt;</li>
  <li>Karen Etheridge &lt;ether@cpan.org&gt;</li>
  <li>Florian Ragwitz &lt;rafl@debian.org&gt;</li>
  <li>Hans Dieter Pearcey &lt;hdp@weftsoar.net&gt;</li>
  <li>Chris Prather &lt;chris@prather.org&gt;</li>
  <li>Matt S Trout &lt;mst@shadowcat.co.uk&gt;</li>
</ul>
</section>
<section class="Sh">
<h1 class="Sh" id="COPYRIGHT_AND_LICENSE"><a class="permalink" href="#COPYRIGHT_AND_LICENSE">COPYRIGHT
  AND LICENSE</a></h1>
This software is copyright (c) 2006 by Infinity Interactive, Inc..
<p class="Pp">This is free software; you can redistribute it and/or modify it
    under the same terms as the Perl 5 programming language system itself.</p>
</section>
</div>
<table class="foot">
  <tr>
    <td class="foot-date">2014-01-19</td>
    <td class="foot-os">perl v5.18.2</td>
  </tr>
</table>
</body>
</html>
