<!DOCTYPE html>
<html>
<!-- This is an automatically generated file.  Do not edit.
   Automatically generated by Pod::Man 4.11 (Pod::Simple 3.35)
  
   Standard preamble:
   ========================================================================
   Vertical space (when we can't use .PP)
 -->
<head>

<style>
@media (prefers-color-scheme: dark) {
  body {
    background: #000;
    color: #d0d0d0;
  }

  a, a:visited {
    color: #1899eb;
  }
}
</style>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    table.head, table.foot { width: 100%; }
    td.head-rtitle, td.foot-os { text-align: right; }
    td.head-vol { text-align: center; }
    .Nd, .Bf, .Op { display: inline; }
    .Pa, .Ad { font-style: italic; }
    .Ms { font-weight: bold; }
    .Bl-diag > dt { font-weight: bold; }
    code.Nm, .Fl, .Cm, .Ic, code.In, .Fd, .Fn, .Cd { font-weight: bold;
      font-family: inherit; }
  </style>
  <title>DBD::SQLite::VirtualTable::PerlData(3)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">DBD::SQLite::VirtualTable::PerlData(3)</td>
    <td class="head-vol">User Contributed Perl Documentation</td>
    <td class="head-rtitle">DBD::SQLite::VirtualTable::PerlData(3)</td>
  </tr>
</table>
<div class="manual-text">
<br/>
<section class="Sh">
<h1 class="Sh" id="NAME"><a class="permalink" href="#NAME">NAME</a></h1>
<p class="Pp">DBD::SQLite::VirtualTable::PerlData -- virtual table hooked to
    Perl data</p>
</section>
<section class="Sh">
<h1 class="Sh" id="SYNOPSIS"><a class="permalink" href="#SYNOPSIS">SYNOPSIS</a></h1>
<p class="Pp">Within Perl :</p>
<p class="Pp"></p>
<pre>  $dbh-&gt;sqlite_create_module(perl =&gt; &quot;DBD::SQLite::VirtualTable::PerlData&quot;);
</pre>
<p class="Pp">Then, within SQL :</p>
<p class="Pp"></p>
<pre>  CREATE VIRTUAL TABLE atbl USING perl(foo, bar, etc,
                                       arrayrefs=&quot;some::global::var::aref&quot;)
  CREATE VIRTUAL TABLE htbl USING perl(foo, bar, etc,
                                       hashrefs=&quot;some::global::var::href&quot;)
  CREATE VIRTUAL TABLE ctbl USING perl(single_col
                                       colref=&quot;some::global::var::ref&quot;)
  SELECT foo, bar FROM atbl WHERE ...;
</pre>
</section>
<section class="Sh">
<h1 class="Sh" id="DESCRIPTION"><a class="permalink" href="#DESCRIPTION">DESCRIPTION</a></h1>
<p class="Pp">A <span class="Li">&quot;PerlData&quot;</span> virtual table is a
    database view on some datastructure within a Perl program. The data can be
    read or modified both from SQL and from Perl. This is useful for simple
    import/export operations, for debugging purposes, for joining data from
    different sources, etc.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="PARAMETERS"><a class="permalink" href="#PARAMETERS">PARAMETERS</a></h1>
<p class="Pp">Parameters for creating a
    <span class="Li">&quot;PerlData&quot;</span> virtual table are specified
    within the <span class="Li">&quot;CREATE VIRTUAL TABLE&quot;</span>
    statement, mixed with regular column declarations, but with an '=' sign.</p>
<p class="Pp">The only authorized (and mandatory) parameter is the one that
    specifies the Perl datastructure to which the virtual table is bound. It
    must be given as the fully qualified name of a global variable; the
    parameter can be one of three different kinds :</p>
<dl class="Bl-tag">
  <dt>&quot;arrayrefs&quot;</dt>
  <dd>arrayref that contains an arrayref for each row. Each such row will have a
      size equivalent to the number of columns declared for the virtual
    table.</dd>
  <dt>&quot;hashrefs&quot;</dt>
  <dd>arrayref that contains a hashref for each row. Keys in each hashref should
      correspond to the columns declared for the virtual table.</dd>
  <dt>&quot;colref&quot;</dt>
  <dd>arrayref that contains a single scalar for each row; obviously, this is a
      single-column virtual table.</dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="USAGE"><a class="permalink" href="#USAGE">USAGE</a></h1>
<section class="Ss">
<h2 class="Ss" id="Common_part_of_all_examples_:_declaring_the_module"><a class="permalink" href="#Common_part_of_all_examples_:_declaring_the_module">Common
  part of all examples : declaring the module</a></h2>
<p class="Pp">In all examples below, the common part is that the Perl program
    should connect to the database and then declare the
    <span class="Li">&quot;PerlData&quot;</span> virtual table module, like
  this</p>
<p class="Pp"></p>
<pre>  # connect to the database
  my $dbh = DBI-&gt;connect(&quot;dbi:SQLite:dbname=$dbfile&quot;, '', '',
                          {RaiseError =&gt; 1, AutoCommit =&gt; 1});
                          # or any other options suitable to your needs
  
  # register the module
  $dbh-&gt;sqlite_create_module(perl =&gt; &quot;DBD::SQLite::VirtualTable::PerlData&quot;);
</pre>
<p class="Pp">Then create a global arrayref variable, using
    <span class="Li">&quot;our&quot;</span> instead of
    <span class="Li">&quot;my&quot;</span>, so that the variable is stored in
    the symbol table of the enclosing module.</p>
<p class="Pp"></p>
<pre>  package Foo::Bar; # could as well be just &quot;main&quot;
  our $rows = [ ... ];
</pre>
<p class="Pp">Finally, create the virtual table and bind it to the global
    variable (here we assume that <span class="Li">@$rows</span> contains
    arrayrefs) :</p>
<p class="Pp"></p>
<pre>  $dbh-&gt;do('CREATE VIRTUAL TABLE temp.vtab'
          .'  USING perl(col1 INT, col2 TEXT, etc,
                         arrayrefs=&quot;Foo::Bar::rows');
</pre>
<p class="Pp">In most cases, the virtual table will be for temporary use, which
    is the reason why this example prepends
    <span class="Li">&quot;temp.&quot;</span> in front of the table name : this
    tells SQLite to cleanup that table when the database handle will be
    disconnected, without the need to emit an explicit DROP statement.</p>
<p class="Pp">Column names (and optionally their types) are specified in the
    virtual table declaration, just like for any regular table.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Arrayref_example_:_statistics_from_files"><a class="permalink" href="#Arrayref_example_:_statistics_from_files">Arrayref
  example : statistics from files</a></h2>
<p class="Pp">Let's suppose we want to perform some searches over a collection
    of files, where search constraints may be based on some of the fields
    returned by stat, such as the size of the file or its last modify time. Here
    is a way to do it with a virtual table :</p>
<p class="Pp"></p>
<pre>  my @files = ... ; # list of files to inspect
  # apply the L&lt;stat&gt; function to each file
  our $file_stats = [ map { [ $_, stat $_ ] } @files];
  # create a temporary virtual table
  $dbh-&gt;do(&lt;&lt;&quot;&quot;);
     CREATE VIRTUAL TABLE temp.file_stats'
        USING perl(path, dev, ino, mode, nlink, uid, gid, rdev, size,
                         atime, mtime, ctime, blksize, blocks,
                   arrayrefs=&quot;main::file_stats&quot;);
  # search files
  my $sth = $dbh-&gt;prepare(&lt;&lt;&quot;&quot;);
    SELECT * FROM file_stats 
      WHERE mtime BETWEEN ? AND ?
        AND uid IN (...)
</pre>
</section>
<section class="Ss">
<h2 class="Ss" id="Hashref_example_:_unicode_characters"><a class="permalink" href="#Hashref_example_:_unicode_characters">Hashref
  example : unicode characters</a></h2>
<p class="Pp">Given any unicode character, the &quot;charinfo&quot; in
    Unicode::UCD function returns a hashref with various bits of information
    about that character. So this can be exploited in a virtual table :</p>
<p class="Pp"></p>
<pre>  use Unicode::UCD 'charinfo';
  our $chars = [map {charinfo($_)} 0x300..0x400]; # arbitrary subrange
  # create a temporary virtual table
  $dbh-&gt;do(&lt;&lt;&quot;&quot;);
    CREATE VIRTUAL TABLE charinfo USING perl(
      code, name, block, script, category,
      hashrefs=&quot;main::chars&quot;
     )
  # search characters
  my $sth = $dbh-&gt;prepare(&lt;&lt;&quot;&quot;);
    SELECT * FROM charinfo 
     WHERE script='Greek' 
       AND name LIKE '%SIGMA%'
</pre>
</section>
<section class="Ss">
<h2 class="Ss" id="Colref_example:_"><a class="permalink" href="#Colref_example:_">Colref
  example: SELECT WHERE ... IN ...</a></h2>
<p class="Pp"><i>Note: The idea for the following example is borrowed from
    the</i> <i></i><span class="Li"><i>&quot;test_intarray.h&quot;</i></span><i>
    file in SQLite's source</i> <i>(&lt;http://www.sqlite.org/src&gt;).</i></p>
<p class="Pp">A <span class="Li">&quot;colref&quot;</span> virtual table is
    designed to facilitate using an array of values as the right-hand side of an
    IN operator. The usual syntax for IN is to prepare a statement like
  this:</p>
<p class="Pp"></p>
<pre>    SELECT * FROM table WHERE x IN (?,?,?,...,?);
</pre>
<p class="Pp">and then bind individual values to each of the ? slots; but this
    has the disadvantage that the number of values must be known in advance.
    Instead, we can store values in a Perl array, bind that array to a virtual
    table, and then write a statement like this</p>
<p class="Pp"></p>
<pre>    SELECT * FROM table WHERE x IN perl_array;
</pre>
<p class="Pp">Here is how such a program would look like :</p>
<p class="Pp"></p>
<pre>  # connect to the database
  my $dbh = DBI-&gt;connect(&quot;dbi:SQLite:dbname=$dbfile&quot;, '', '',
                          {RaiseError =&gt; 1, AutoCommit =&gt; 1});
  
  # Declare a global arrayref containing the values. Here we assume
  # they are taken from @ARGV, but any other datasource would do.
  # Note the use of &quot;our&quot; instead of &quot;my&quot;.
  our $values = \@ARGV; 
  
  # register the module and declare the virtual table
  $dbh-&gt;sqlite_create_module(perl =&gt; &quot;DBD::SQLite::VirtualTable::PerlData&quot;);
  $dbh-&gt;do('CREATE VIRTUAL TABLE temp.intarray'
          .'  USING perl(i INT, colref=&quot;main::values');
  
  # now we can SELECT from another table, using the intarray as a constraint
  my $sql    = &quot;SELECT * FROM some_table WHERE some_col IN intarray&quot;;
  my $result = $dbh-&gt;selectall_arrayref($sql);
</pre>
<p class="Pp">Beware that the virtual table is read-write, so the statement
    below would push 99 into <span class="Li">@ARGV</span> !</p>
<p class="Pp"></p>
<pre>  INSERT INTO intarray VALUES (99);
</pre>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="AUTHOR"><a class="permalink" href="#AUTHOR">AUTHOR</a></h1>
<p class="Pp">Laurent Dami &lt;dami@cpan.org&gt;</p>
</section>
<section class="Sh">
<h1 class="Sh" id="COPYRIGHT_AND_LICENSE"><a class="permalink" href="#COPYRIGHT_AND_LICENSE">COPYRIGHT
  AND LICENSE</a></h1>
<p class="Pp">Copyright Laurent Dami, 2014.</p>
<p class="Pp">This library is free software; you can redistribute it and/or
    modify it under the same terms as Perl itself.</p>
</section>
</div>
<table class="foot">
  <tr>
    <td class="foot-date">2019-05-22</td>
    <td class="foot-os">perl v5.30.2</td>
  </tr>
</table>
</body>
</html>
