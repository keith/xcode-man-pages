<!DOCTYPE html>
<html>
<!-- This is an automatically generated file.  Do not edit.
   Copyright (c) 1989-1993 The Regents of the University of California.
   Copyright (c) 1994-1997 Sun Microsystems, Inc.
  
   See the file "license.terms" for information on usage and redistribution
   of this file, and for a DISCLAIMER OF ALL WARRANTIES.
  
   RCS: @(#) $Id: AddErrInfo.3,v 1.20 2007/12/13 15:22:30 dgp Exp $
  
   The -*- nroff -*- definitions below are for supplemental macros used
   in Tcl/Tk manual entries.
  
   .AP type name in/out ?indent?
  	Start paragraph describing an argument to a library procedure.
  	type is type of argument (int, etc.), in/out is either "in", "out",
  	or "in/out" to describe whether procedure reads or modifies arg,
  	and indent is equivalent to second arg of .IP (shouldn't ever be
  	needed;  use .AS below instead)
  
   .AS ?type? ?name?
  	Give maximum sizes of arguments for setting tab stops.  Type and
  	name are examples of largest possible arguments that will be passed
  	to .AP later.  If args are omitted, default tab stops are used.
  
   .BS
  	Start box enclosure.  From here until next .BE, everything will be
  	enclosed in one large box.
  
   .BE
  	End of box enclosure.
  
   .CS
  	Begin code excerpt.
  
   .CE
  	End code excerpt.
  
   .VS ?version? ?br?
  	Begin vertical sidebar, for use in marking newly-changed parts
  	of man pages.  The first argument is ignored and used for recording
  	the version when the .VS was added, so that the sidebars can be
  	found and removed when they reach a certain age.  If another argument
  	is present, then a line break is forced before starting the sidebar.
  
   .VE
  	End of vertical sidebar.
  
   .DS
  	Begin an indented unfilled display.
  
   .DE
  	End of indented unfilled display.
  
   .SO ?manpage?
  	Start of list of standard options for a Tk widget. The manpage
  	argument defines where to look up the standard options; if
  	omitted, defaults to "options". The options follow on successive
  	lines, in three columns separated by tabs.
  
   .SE
  	End of list of standard options for a Tk widget.
  
   .OP cmdName dbName dbClass
  	Start of description of a specific option.  cmdName gives the
  	option's name as specified in the class command, dbName gives
  	the option's name in the option database, and dbClass gives
  	the option's class in the option database.
  
   .UL arg1 arg2
  	Print arg1 underlined, then print arg2 normally.
  
   .QW arg1 ?arg2?
  	Print arg1 in quotes, then arg2 normally (for trailing punctuation).
  
   .PQ arg1 ?arg2?
  	Print an open parenthesis, arg1 in quotes, then arg2 normally
  	(for trailing punctuation) and then a closing parenthesis.
  
   RCS: @(#) $Id: man.macros,v 1.9 2008/01/29 15:32:33 dkf Exp $
  
  	# Set up traps and other miscellaneous stuff for Tcl/Tk man pages.
  	# Start an argument description
  .b
  	# define tabbing values for .AP
  
  	# BS - start boxed text
  	# ^y = starting y location
  	# ^b = 1
  	# BE - end boxed text (draw box now)
  	Draw four-sided box normally, but don't draw top of
  	box if the box started on an earlier page.
  	# VS - start vertical sidebar
  	# ^Y = starting y location
  	# ^v = 1 (for troff;  for nroff this doesn't matter)
  	# VE - end of vertical sidebar
  	# Special macro to handle page bottom:  finish off current
  	# box/sidebar if in box/sidebar mode, then invoked standard
  	# page bottom macro.
  	Draw three-sided box if this is the box's first page,
  	draw two sides but no top otherwise.
  	# DS - begin display
  	# DE - end display
  	# SO - start of list of standard options
  	# SE - end of list of standard options
  	# OP - start of full description for a single option
  	# CS - begin code excerpt
  	# CE - end code excerpt
  	# UL - underline word
  	# QW - apply quotation marks to word
  " fix emacs highlighting
  	# PQ - apply parens and quotation marks to word
  " fix emacs highlighting
  	# QR - quoted range
  " fix emacs highlighting
  	# MT - "empty" string
 -->
<head>

<style>
@media (prefers-color-scheme: dark) {
  body {
    background: #000;
    color: #d0d0d0;
  }

  a, a:visited {
    color: #1899eb;
  }
}
</style>

  <meta charset="utf-8"/>
  <style>
    table.head, table.foot { width: 100%; }
    td.head-rtitle, td.foot-os { text-align: right; }
    td.head-vol { text-align: center; }
    div.Pp { margin: 1ex 0ex; }
    div.Nd, div.Bf, div.Op { display: inline; }
    span.Pa, span.Ad { font-style: italic; }
    span.Ms { font-weight: bold; }
    dl.Bl-diag > dt { font-weight: bold; }
    code.Nm, code.Fl, code.Cm, code.Ic, code.In, code.Fd, code.Fn,
    code.Cd { font-weight: bold; font-family: inherit; }
  </style>
  <title>Tcl_AddErrorInfo(3)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">Tcl_AddErrorInfo(3)</td>
    <td class="head-vol">Tcl Library Procedures</td>
    <td class="head-rtitle">Tcl_AddErrorInfo(3)</td>
  </tr>
</table>
<div class="manual-text">
<br/>
<pre>

</pre>
<section class="Sh">
<h1 class="Sh" id="NAME"><a class="permalink" href="#NAME">NAME</a></h1>
Tcl_GetReturnOptions, Tcl_SetReturnOptions, Tcl_AddErrorInfo,
  Tcl_AppendObjToErrorInfo, Tcl_AddObjErrorInfo, Tcl_SetObjErrorCode,
  Tcl_SetErrorCode, Tcl_SetErrorCodeVA, Tcl_PosixError, Tcl_LogCommandInfo -
  retrieve or record information about errors and other return options
</section>
<section class="Sh">
<h1 class="Sh" id="SYNOPSIS"><a class="permalink" href="#SYNOPSIS">SYNOPSIS</a></h1>
<pre>
<b>#include &lt;tcl.h&gt;</b>

Tcl_Obj *
<b>Tcl_GetReturnOptions</b>(<i>interp, code</i>)

int 
<b>Tcl_SetReturnOptions</b>(<i>interp, options</i>)

<b>Tcl_AddErrorInfo</b>(<i>interp, message</i>)

<b>Tcl_AppendObjToErrorInfo</b>(<i>interp, objPtr</i>)

<b>Tcl_AddObjErrorInfo</b>(<i>interp, message, length</i>)

<b>Tcl_SetObjErrorCode</b>(<i>interp, errorObjPtr</i>)

<b>Tcl_SetErrorCode</b>(<i>interp, element, element, ... </i><b>(char *) NULL</b>)

<b>Tcl_SetErrorCodeVA</b>(<i>interp, argList</i>)

const char *
<b>Tcl_PosixError</b>(<i>interp</i>)

void
<b>Tcl_LogCommandInfo</b>(<i>interp, script, command, commandLength</i>)
</pre>
</section>
<section class="Sh">
<h1 class="Sh" id="ARGUMENTS"><a class="permalink" href="#ARGUMENTS">ARGUMENTS</a></h1>
<dl class="Bl-tag">
  <dt>Tcl_Interp <i>*interp</i> (in)</dt>
  <dd>Interpreter in which to record information.</dd>
</dl>
<br/>
int	<i>code</i> The code returned from script evaluation.
<br/>
Tcl_Obj	<i>*options</i> A dictionary of return options.
<dl class="Bl-tag">
  <dt>char <i>*message</i> (in)</dt>
  <dd>For <b>Tcl_AddErrorInfo</b>, this is a conventional C string to append to
      the <b>-errorinfo</b> return option. For <b>Tcl_AddObjErrorInfo</b>, this
      points to the first byte of an array of <i>length</i> bytes containing a
      string to append to the <b>-errorinfo</b> return option. This byte array
      may contain embedded null bytes unless <i>length</i> is negative.</dd>
  <dt>Tcl_Obj <i>*objPtr</i> (in)</dt>
  <dd>A message to be appended to the <b>-errorinfo</b> return option in the
      form of a Tcl_Obj value.</dd>
  <dt>int <i>length</i> (in)</dt>
  <dd>The number of bytes to copy from <i>message</i> when appending to the
      <b>-errorinfo</b> return option. If negative, all bytes up to the first
      null byte are used.</dd>
  <dt>Tcl_Obj <i>*errorObjPtr</i> (in)</dt>
  <dd>The <b>-errorcode</b> return option will be set to this value.</dd>
  <dt>char <i>*element</i> (in)</dt>
  <dd>String to record as one element of the <b>-errorcode</b> return option.
      Last <i>element</i> argument must be NULL.</dd>
  <dt>va_list <i>argList</i> (in)</dt>
  <dd>An argument list which must have been initialized using <b>va_start</b>,
      and cleared using <b>va_end</b>.</dd>
  <dt>const char <i>*script</i> (in)</dt>
  <dd>Pointer to first character in script containing command (must be &lt;=
      command)</dd>
  <dt>const char <i>*command</i> (in)</dt>
  <dd>Pointer to first character in command that generated the error</dd>
  <dt>int <i>commandLength</i> (in)</dt>
  <dd>Number of bytes in command; -1 means use all bytes up to first null byte
    <pre>

    </pre>
    <p class="Pp"></p>
  </dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="DESCRIPTION"><a class="permalink" href="#DESCRIPTION">DESCRIPTION</a></h1>
The <b>Tcl_SetReturnOptions</b> and <b>Tcl_GetReturnOptions</b> routines expose
  the same capabilities as the <b>return</b> and <b>catch</b> commands,
  respectively, in the form of a C interface.
<p class="Pp"><b>Tcl_GetReturnOptions</b> retrieves the dictionary of return
    options from an interpreter following a script evaluation. Routines such as
    <b>Tcl_Eval</b> are called to evaluate a script in an interpreter. These
    routines return an integer completion code. These routines also leave in the
    interpreter both a result and a dictionary of return options generated by
    script evaluation. Just as <b>Tcl_GetObjResult</b> retrieves the result,
    <b>Tcl_GetReturnOptions</b> retrieves the dictionary of return options. The
    integer completion code should be passed as the <i>code</i> argument to
    <b>Tcl_GetReturnOptions</b> so that all required options will be present in
    the dictionary. Specifically, a <i>code</i> value of <b>TCL_ERROR</b> will
    ensure that entries for the keys <b>-errorinfo</b>, <b>-errorcode</b>, and
    <b>-errorline</b> will appear in the dictionary. Also, the entries for the
    keys <b>-code</b> and <b>-level</b> will be adjusted if necessary to agree
    with the value of <i>code</i>. The <b>(Tcl_Obj *)</b> returned by
    <b>Tcl_GetReturnOptions</b> points to an unshared <b>Tcl_Obj</b> with
    reference count of zero. The dictionary may be written to, either adding,
    removing, or overwriting any entries in it, with the need to check for a
    shared object.</p>
<p class="Pp">A typical usage for <b>Tcl_GetReturnOptions</b> is to retrieve the
    stack trace when script evaluation returns <b>TCL_ERROR</b>, like so:</p>
<div class="Bd-indent">
<pre>
int code = Tcl_Eval(interp, script);
if (code == TCL_ERROR) {
    Tcl_Obj *options = Tcl_GetReturnOptions(interp, code);  
    Tcl_Obj *key = Tcl_NewStringObj(&quot;-errorinfo&quot;, -1);
    Tcl_Obj *stackTrace;
    Tcl_IncrRefCount(key);
    Tcl_DictObjGet(NULL, options, key, &amp;stackTrace);
    Tcl_DecrRefCount(key);
    /* Do something with stackTrace */
}
</pre>
</div>
<p class="Pp"><b>Tcl_SetReturnOptions</b> sets the return options of
    <i>interp</i> to be <i>options</i>. If <i>options</i> contains any invalid
    value for any key, TCL_ERROR will be returned, and the interp result will be
    set to an appropriate error message. Otherwise, a completion code in
    agreement with the <b>-code</b> and <b>-level</b> keys in <i>options</i>
    will be returned.</p>
<p class="Pp">As an example, Tcl's <b>return</b> command itself could be
    implemented in terms of <b>Tcl_SetReturnOptions</b> like so:</p>
<div class="Bd-indent">
<pre>
if ((objc % 2) == 0) { /* explicit result argument */
    objc--;
    Tcl_SetObjResult(interp, objv[objc]);
}
return Tcl_SetReturnOptions(interp, Tcl_NewListObj(objc-1, objv+1));
</pre>
</div>
(It is not really implemented that way. Internal access privileges allow for a
  more efficient alternative that meshes better with the bytecode compiler.)
<p class="Pp">Note that a newly created <b>Tcl_Obj</b> may be passed in as the
    <i>options</i> argument without the need to tend to any reference counting.
    This is analogous to <b>Tcl_SetObjResult</b>.</p>
<p class="Pp">While <b>Tcl_SetReturnOptions</b> provides a general interface to
    set any collection of return options, there are a handful of return options
    that are very frequently used. Most notably the <b>-errorinfo</b> and
    <b>-errorcode</b> return options should be set properly when the command
    procedure of a command returns <b>TCL_ERROR</b>. Tcl provides several
    simpler interfaces to more directly set these return options.</p>
<p class="Pp">The <b>-errorinfo</b> option holds a stack trace of the operations
    that were in progress when an error occurred, and is intended to be
    human-readable. The <b>-errorcode</b> option holds a list of items that are
    intended to be machine-readable. The first item in the <b>-errorcode</b>
    value identifies the class of error that occurred (e.g. POSIX means an error
    occurred in a POSIX system call) and additional elements hold additional
    pieces of information that depend on the class. See the tclvars manual entry
    for details on the various formats for the <b>-errorcode</b> option used by
    Tcl's built-in commands.</p>
<p class="Pp">The <b>-errorinfo</b> option value is gradually built up as an
    error unwinds through the nested operations. Each time an error code is
    returned to <b>Tcl_Eval</b>, or any of the routines that performs script
    evaluation, the procedure <b>Tcl_AddErrorInfo</b> is called to add
    additional text to the <b>-errorinfo</b> value describing the command that
    was being executed when the error occurred. By the time the error has been
    passed all the way back to the application, it will contain a complete trace
    of the activity in progress when the error occurred.</p>
<p class="Pp">It is sometimes useful to add additional information to the
    <b>-errorinfo</b> value beyond what can be supplied automatically by the
    script evaluation routines. <b>Tcl_AddErrorInfo</b> may be used for this
    purpose: its <i>message</i> argument is an additional string to be appended
    to the <b>-errorinfo</b> option. For example, when an error arises during
    the <b>source</b> command, the procedure <b>Tcl_AddErrorInfo</b> is called
    to record the name of the file being processed and the line number on which
    the error occurred. Likewise, when an error arises during evaluation of a
    Tcl procedures, the procedure name and line number within the procedure are
    recorded, and so on. The best time to call <b>Tcl_AddErrorInfo</b> is just
    after a script evaluation routine has returned <b>TCL_ERROR</b>. The value
    of the <b>-errorline</b> return option (retrieved via a call to
    <b>Tcl_GetReturnOptions</b>) often makes up a useful part of the
    <i>message</i> passed to <b>Tcl_AddErrorInfo</b>.</p>
<p class="Pp"><b>Tcl_AppendObjToErrorInfo</b> is an alternative interface to the
    same functionality as <b>Tcl_AddErrorInfo</b>.
    <b>Tcl_AppendObjToErrorInfo</b> is called when the string value to be
    appended to the <b>-errorinfo</b> option is available as a <b>Tcl_Obj</b>
    instead of as a <b>char</b> array.</p>
<p class="Pp"><b>Tcl_AddObjErrorInfo</b> is nearly identical to
    <b>Tcl_AddErrorInfo</b>, except that it has an additional <i>length</i>
    argument. This allows the <i>message</i> string to contain embedded null
    bytes. This is essentially never a good idea. If the <i>message</i> needs to
    contain the null character <b>U+0000</b>, Tcl's usual internal encoding
    rules should be used to avoid the need for a null byte. If the
    <b>Tcl_AddObjErrorInfo</b> interface is used at all, it should be with a
    negative <i>length</i> value.</p>
<p class="Pp">The procedure <b>Tcl_SetObjErrorCode</b> is used to set the
    <b>-errorcode</b> return option to the list object <i>errorObjPtr</i> built
    up by the caller. <b>Tcl_SetObjErrorCode</b> is typically invoked just
    before returning an error. If an error is returned without calling
    <b>Tcl_SetObjErrorCode</b> or <b>Tcl_SetErrorCode</b> the Tcl interpreter
    automatically sets the <b>-errorcode</b> return option to <b>NONE</b>.</p>
<p class="Pp">The procedure <b>Tcl_SetErrorCode</b> is also used to set the
    <b>-errorcode</b> return option. However, it takes one or more strings to
    record instead of an object. Otherwise, it is similar to
    <b>Tcl_SetObjErrorCode</b> in behavior.</p>
<p class="Pp"><b>Tcl_SetErrorCodeVA</b> is the same as <b>Tcl_SetErrorCode</b>
    except that instead of taking a variable number of arguments it takes an
    argument list.</p>
<p class="Pp"><b>Tcl_PosixError</b> sets the <b>-errorcode</b> variable after an
    error in a POSIX kernel call. It reads the value of the <b>errno</b> C
    variable and calls <b>Tcl_SetErrorCode</b> to set the <b>-errorcode</b>
    return option in the <b>POSIX</b> format. The caller must previously have
    called <b>Tcl_SetErrno</b> to set <b>errno</b>; this is necessary on some
    platforms (e.g. Windows) where Tcl is linked into an application as a shared
    library, or when the error occurs in a dynamically loaded extension. See the
    manual entry for <b>Tcl_SetErrno</b> for more information.</p>
<p class="Pp"><b>Tcl_PosixError</b> returns a human-readable diagnostic message
    for the error (this is the same value that will appear as the third element
    in the <b>-errorcode</b> value). It may be convenient to include this string
    as part of the error message returned to the application in the
    interpreter's result.</p>
<p class="Pp"><b>Tcl_LogCommandInfo</b> is invoked after an error occurs in an
    interpreter. It adds information about the command that was being executed
    when the error occurred to the <b>-errorinfo</b> value, and the line number
    stored internally in the interpreter is set.</p>
<p class="Pp">In older releases of Tcl, there was no <b>Tcl_GetReturnOptions</b>
    routine. In its place, the global Tcl variables <b>errorInfo</b> and
    <b>errorCode</b> were the only place to retrieve the error information. Much
    existing code written for older Tcl releases still access this information
    via those global variables.</p>
<p class="Pp">It is important to realize that while reading from those global
    variables remains a supported way to access these return option values, it
    is important not to assume that writing to those global variables will
    properly set the corresponding return options. It has long been emphasized
    in this manual page that it is important to call the procedures described
    here rather than setting <b>errorInfo</b> or <b>errorCode</b> directly with
    <b>Tcl_ObjSetVar2</b>.</p>
<p class="Pp">If the procedure <b>Tcl_ResetResult</b> is called, it clears all
    of the state of the interpreter associated with script evaluation, including
    the entire return options dictionary. In particular, the <b>-errorinfo</b>
    and <b>-errorcode</b> options are reset. If an error had occurred, the
    <b>Tcl_ResetResult</b> call will clear the error state to make it appear as
    if no error had occurred after all. The global variables <b>errorInfo</b>
    and <b>errorCode</b> are not modified by <b>Tcl_ResetResult</b> so they
    continue to hold a record of information about the most recent error seen in
    an interpreter.</p>
<p class="Pp"></p>
</section>
<section class="Sh">
<h1 class="Sh" id="SEE_ALSO"><a class="permalink" href="#SEE_ALSO">SEE
  ALSO</a></h1>
Tcl_DecrRefCount, Tcl_IncrRefCount, Tcl_Interp, Tcl_ResetResult, Tcl_SetErrno
<p class="Pp"></p>
</section>
<section class="Sh">
<h1 class="Sh" id="KEYWORDS"><a class="permalink" href="#KEYWORDS">KEYWORDS</a></h1>
error, object, object result, stack, trace, variable
</section>
</div>
<table class="foot">
  <tr>
    <td class="foot-date">8.5</td>
    <td class="foot-os">Tcl</td>
  </tr>
</table>
</body>
</html>
