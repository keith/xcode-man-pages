<!DOCTYPE html>
<html>
<!-- This is an automatically generated file.  Do not edit.
   Automatically generated by Pod::Man 2.27 (Pod::Simple 3.28)
  
   Standard preamble:
   ========================================================================
   Vertical space (when we can't use .PP)
   Begin verbatim text
   End verbatim text
   Set up some character translations and predefined strings.  \*(-- will
   give an unbreakable dash, \*(PI will give pi, \*(L" will give a left
   double quote, and \*(R" will give a right double quote.  \*(C+ will
   give a nicer C++.  Capital omega is used to do unbreakable dashes and
   therefore won't be available.  \*(C` and \*(C' expand to `' in nroff,
   nothing in troff, for use with C<>.
   diablo 10 pitch
    diablo 12 pitch
 -->
<head>
  <meta charset="utf-8"/>
  <style>
    table.head, table.foot { width: 100%; }
    td.head-rtitle, td.foot-os { text-align: right; }
    td.head-vol { text-align: center; }
    div.Pp { margin: 1ex 0ex; }
    div.Nd, div.Bf, div.Op { display: inline; }
    span.Pa, span.Ad { font-style: italic; }
    span.Ms { font-weight: bold; }
    dl.Bl-diag > dt { font-weight: bold; }
    code.Nm, code.Fl, code.Cm, code.Ic, code.In, code.Fd, code.Fn,
    code.Cd { font-weight: bold; font-family: inherit; }
  </style>
  <title>Moose::Cookbook::Basics::Genome_OverloadingSubtypesAndCoercion(3)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">Moose::Cookbook::Basics::Genome_OverloadingSubtypesAndCoercion(3)</td>
    <td class="head-vol">User Contributed Perl Documentation</td>
    <td class="head-rtitle">Moose::Cookbook::Basics::Genome_OverloadingSubtypesAndCoercion(3)</td>
  </tr>
</table>
<div class="manual-text">
<br/>
<section class="Sh">
<h1 class="Sh" id="NAME"><a class="permalink" href="#NAME">NAME</a></h1>
Moose::Cookbook::Basics::Genome_OverloadingSubtypesAndCoercion - Operator
  overloading, subtypes, and coercion
</section>
<section class="Sh">
<h1 class="Sh" id="VERSION"><a class="permalink" href="#VERSION">VERSION</a></h1>
version 2.1202
</section>
<section class="Sh">
<h1 class="Sh" id="SYNOPSIS"><a class="permalink" href="#SYNOPSIS">SYNOPSIS</a></h1>
<span class="Li"></span>
<pre>
  package Human;

  use Moose;
  use Moose::Util::TypeConstraints;

  subtype 'Sex'
      =&gt; as 'Str'
      =&gt; where { $_ =~ m{^[mf]$}s };

  has 'sex'    =&gt; ( is =&gt; 'ro', isa =&gt; 'Sex', required =&gt; 1 );

  has 'mother' =&gt; ( is =&gt; 'ro', isa =&gt; 'Human' );
  has 'father' =&gt; ( is =&gt; 'ro', isa =&gt; 'Human' );

  use overload '+' =&gt; \&amp;_overload_add, fallback =&gt; 1;

  sub _overload_add {
      my ( $one, $two ) = @_;

      die('Only male and female humans may create children')
          if ( $one-&gt;sex() eq $two-&gt;sex() );

      my ( $mother, $father )
          = ( $one-&gt;sex eq 'f' ? ( $one, $two ) : ( $two, $one ) );

      my $sex = 'f';
      $sex = 'm' if ( rand() &gt;= 0.5 );

      return Human-&gt;new(
          sex    =&gt; $sex,
          mother =&gt; $mother,
          father =&gt; $father,
      );
  }
</pre>
</section>
<section class="Sh">
<h1 class="Sh" id="DESCRIPTION"><a class="permalink" href="#DESCRIPTION">DESCRIPTION</a></h1>
This Moose cookbook recipe shows how operator overloading, coercion, and
  subtypes can be used to mimic the human reproductive system (well, the
  selection of genes at least).
</section>
<section class="Sh">
<h1 class="Sh" id="INTRODUCTION"><a class="permalink" href="#INTRODUCTION">INTRODUCTION</a></h1>
Our <span class="Li">&quot;Human&quot;</span> class uses operator overloading to
  allow us to &quot;add&quot; two humans together and produce a child. Our
  implementation does require that the two objects be of opposite sex. Remember,
  we're talking about biological reproduction, not marriage.
<p class="Pp">While this example works as-is, we can take it a lot further by
    adding genes into the mix. We'll add the two genes that control eye color,
    and use overloading to combine the genes from the parent to model the
    biology.</p>
<section class="Ss">
<h2 class="Ss" id="What_is_Operator_Overloading?"><a class="permalink" href="#What_is_Operator_Overloading?">What
  is Operator Overloading?</a></h2>
Overloading is <i>not</i> a Moose-specific feature. It's a general OO concept
  that is implemented in Perl with the
  <span class="Li">&quot;overload&quot;</span> pragma. Overloading lets objects
  do something sane when used with Perl's built in operators, like addition
  (<span class="Li">&quot;+&quot;</span>) or when used as a string.
<p class="Pp">In this example we overload addition so we can write code like
    <span class="Li">&quot;$child = $mother + $father&quot;</span>.</p>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="GENES"><a class="permalink" href="#GENES">GENES</a></h1>
There are many genes which affect eye color, but there are two which are most
  important, <i>gey</i> and <i>bey2</i>. We will start by making a class for
  each gene.
<section class="Ss">
<h2 class="Ss" id="Human::Gene::bey2"><a class="permalink" href="#Human::Gene::bey2">Human::Gene::bey2</a></h2>
<span class="Li"></span>
<pre>
  package Human::Gene::bey2;

  use Moose;
  use Moose::Util::TypeConstraints;

  type 'bey2_color' =&gt; where { $_ =~ m{^(?:brown|blue)$} };

  has 'color' =&gt; ( is =&gt; 'ro', isa =&gt; 'bey2_color' );
</pre>
<p class="Pp">This class is trivial. We have a type constraint for the allowed
    colors, and a <span class="Li">&quot;color&quot;</span> attribute.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="Human::Gene::gey"><a class="permalink" href="#Human::Gene::gey">Human::Gene::gey</a></h2>
<span class="Li"></span>
<pre>
  package Human::Gene::gey;

  use Moose;
  use Moose::Util::TypeConstraints;

  type 'gey_color' =&gt; where { $_ =~ m{^(?:green|blue)$} };

  has 'color' =&gt; ( is =&gt; 'ro', isa =&gt; 'gey_color' );
</pre>
<p class="Pp">This is nearly identical to the
    <span class="Li">&quot;Humane::Gene::bey2&quot;</span> class, except that
    the <i>gey</i> gene allows for different colors.</p>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="EYE_COLOR"><a class="permalink" href="#EYE_COLOR">EYE
  COLOR</a></h1>
We could just give four attributes (two of each gene) to the
  <span class="Li">&quot;Human&quot;</span> class, but this is a bit messy.
  Instead, we'll abstract the genes into a container class,
  <span class="Li">&quot;Human::EyeColor&quot;</span>. Then a
  <span class="Li">&quot;Human&quot;</span> can have a single
  <span class="Li">&quot;eye_color&quot;</span> attribute.
<p class="Pp"><span class="Li"></span></p>
<pre>
  package Human::EyeColor;

  use Moose;
  use Moose::Util::TypeConstraints;

  coerce 'Human::Gene::bey2'
      =&gt; from 'Str'
          =&gt; via { Human::Gene::bey2-&gt;new( color =&gt; $_ ) };

  coerce 'Human::Gene::gey'
      =&gt; from 'Str'
          =&gt; via { Human::Gene::gey-&gt;new( color =&gt; $_ ) };

  has [qw( bey2_1 bey2_2 )] =&gt;
      ( is =&gt; 'ro', isa =&gt; 'Human::Gene::bey2', coerce =&gt; 1 );

  has [qw( gey_1 gey_2 )] =&gt;
      ( is =&gt; 'ro', isa =&gt; 'Human::Gene::gey', coerce =&gt; 1 );
</pre>
<p class="Pp">The eye color class has two of each type of gene. We've also
    created a coercion for each class that coerces a string into a new object.
    Note that a coercion will fail if it attempts to coerce a string like
    &quot;indigo&quot;, because that is not a valid color for either type of
    gene.</p>
<p class="Pp">As an aside, you can see that we can define several identical
    attributes at once by supplying an array reference of names as the first
    argument to <span class="Li">&quot;has&quot;</span>.</p>
<p class="Pp">We also need a method to calculate the actual eye color that
    results from a set of genes. The <i>bey2</i> brown gene is dominant over
    both blue and green. The <i>gey</i> green gene is dominant over blue.</p>
<p class="Pp"><span class="Li"></span></p>
<pre>
  sub color {
      my ($self) = @_;

      return 'brown'
          if ( $self-&gt;bey2_1-&gt;color() eq 'brown'
          or $self-&gt;bey2_2-&gt;color() eq 'brown' );

      return 'green'
          if ( $self-&gt;gey_1-&gt;color() eq 'green'
          or $self-&gt;gey_2-&gt;color() eq 'green' );

      return 'blue';
  }
</pre>
<p class="Pp">We'd like to be able to treat a
    <span class="Li">&quot;Human::EyeColor&quot;</span> object as a string, so
    we define a string overloading for the class:</p>
<p class="Pp"><span class="Li"></span></p>
<pre>
  use overload '&quot;&quot;' =&gt; \&amp;color, fallback =&gt; 1;
</pre>
<p class="Pp">Finally, we need to define overloading for addition. That way we
    can add together two <span class="Li">&quot;Human::EyeColor&quot;</span>
    objects and get a new one with a new (genetically correct) eye color.</p>
<p class="Pp"><span class="Li"></span></p>
<pre>
  use overload '+' =&gt; \&amp;_overload_add, fallback =&gt; 1;

  sub _overload_add {
      my ( $one, $two ) = @_;

      my $one_bey2 = 'bey2_' . _rand2();
      my $two_bey2 = 'bey2_' . _rand2();

      my $one_gey = 'gey_' . _rand2();
      my $two_gey = 'gey_' . _rand2();

      return Human::EyeColor-&gt;new(
          bey2_1 =&gt; $one-&gt;$one_bey2-&gt;color(),
          bey2_2 =&gt; $two-&gt;$two_bey2-&gt;color(),
          gey_1  =&gt; $one-&gt;$one_gey-&gt;color(),
          gey_2  =&gt; $two-&gt;$two_gey-&gt;color(),
      );
  }

  sub _rand2 {
      return 1 + int( rand(2) );
  }
</pre>
<p class="Pp">When two eye color objects are added together, the
    <span class="Li">&quot;_overload_add()&quot;</span> method will be passed
    two <span class="Li">&quot;Human::EyeColor&quot;</span> objects. These are
    the left and right side operands for the
    <span class="Li">&quot;+&quot;</span> operator. This method returns a new
    <span class="Li">&quot;Human::EyeColor&quot;</span> object.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="ADDING_EYE_COLOR_TO__Human_s"><a class="permalink" href="#ADDING_EYE_COLOR_TO__Human_s">ADDING
  EYE COLOR TO &quot;Human&quot;s</a></h1>
Our original <span class="Li">&quot;Human&quot;</span> class requires just a few
  changes to incorporate our new
  <span class="Li">&quot;Human::EyeColor&quot;</span> class.
<p class="Pp"><span class="Li"></span></p>
<pre>
  use List::MoreUtils qw( zip );

  coerce 'Human::EyeColor'
      =&gt; from 'ArrayRef'
      =&gt; via { my @genes = qw( bey2_1 bey2_2 gey_1 gey_2 );
               return Human::EyeColor-&gt;new( zip( @genes, @{$_} ) ); };

  has 'eye_color' =&gt; (
      is       =&gt; 'ro',
      isa      =&gt; 'Human::EyeColor',
      coerce   =&gt; 1,
      required =&gt; 1,
  );
</pre>
<p class="Pp">We also need to modify
    <span class="Li">&quot;_overload_add()&quot;</span> in the
    <span class="Li">&quot;Human&quot;</span> class to account for eye
  color:</p>
<p class="Pp"><span class="Li"></span></p>
<pre>
  return Human-&gt;new(
      sex       =&gt; $sex,
      eye_color =&gt; ( $one-&gt;eye_color() + $two-&gt;eye_color() ),
      mother    =&gt; $mother,
      father    =&gt; $father,
  );
</pre>
</section>
<section class="Sh">
<h1 class="Sh" id="CONCLUSION"><a class="permalink" href="#CONCLUSION">CONCLUSION</a></h1>
The three techniques we used, overloading, subtypes, and coercion, combine to
  provide a powerful interface.
<p class="Pp">If you'd like to learn more about overloading, please read the
    documentation for the overload pragma.</p>
<p class="Pp">To see all the code we created together, take a look at
    <i>t/recipes/basics_recipe9.t</i>.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="NEXT_STEPS"><a class="permalink" href="#NEXT_STEPS">NEXT
  STEPS</a></h1>
Had this been a real project we'd probably want:
<dl class="Bl-tag">
  <dt>Better Randomization with Crypt::Random</dt>
  <dd></dd>
  <dt>Characteristic Base Class</dt>
  <dd></dd>
  <dt>Mutating Genes</dt>
  <dd></dd>
  <dt>More Characteristics</dt>
  <dd></dd>
  <dt>Artificial Life</dt>
  <dd></dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="LICENSE"><a class="permalink" href="#LICENSE">LICENSE</a></h1>
This work is licensed under a Creative Commons Attribution 3.0 Unported License.
<p class="Pp">License details are at:
    &lt;http://creativecommons.org/licenses/by/3.0/&gt;</p>
</section>
<section class="Sh">
<h1 class="Sh" id="AUTHORS"><a class="permalink" href="#AUTHORS">AUTHORS</a></h1>
<ul class="Bl-bullet">
  <li>Stevan Little &lt;stevan.little@iinteractive.com&gt;</li>
  <li>Dave Rolsky &lt;autarch@urth.org&gt;</li>
  <li>Jesse Luehrs &lt;doy@tozt.net&gt;</li>
  <li>Shawn M Moore &lt;code@sartak.org&gt;</li>
  <li>XXXX XXX'XX (Yuval Kogman) &lt;nothingmuch@woobling.org&gt;</li>
  <li>Karen Etheridge &lt;ether@cpan.org&gt;</li>
  <li>Florian Ragwitz &lt;rafl@debian.org&gt;</li>
  <li>Hans Dieter Pearcey &lt;hdp@weftsoar.net&gt;</li>
  <li>Chris Prather &lt;chris@prather.org&gt;</li>
  <li>Matt S Trout &lt;mst@shadowcat.co.uk&gt;</li>
</ul>
</section>
<section class="Sh">
<h1 class="Sh" id="COPYRIGHT_AND_LICENSE"><a class="permalink" href="#COPYRIGHT_AND_LICENSE">COPYRIGHT
  AND LICENSE</a></h1>
This software is copyright (c) 2006 by Infinity Interactive, Inc..
<p class="Pp">This is free software; you can redistribute it and/or modify it
    under the same terms as the Perl 5 programming language system itself.</p>
</section>
</div>
<table class="foot">
  <tr>
    <td class="foot-date">2014-01-19</td>
    <td class="foot-os">perl v5.18.2</td>
  </tr>
</table>
</body>
</html>
