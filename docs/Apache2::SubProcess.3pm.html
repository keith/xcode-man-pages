<!DOCTYPE html>
<html>
<!-- This is an automatically generated file.  Do not edit.
   Automatically generated by Pod::Man 4.11 (Pod::Simple 3.35)
  
   Standard preamble:
   ========================================================================
   Vertical space (when we can't use .PP)
 -->
<head>

<style>
@media (prefers-color-scheme: dark) {
  body {
    background: #000;
    color: #d0d0d0;
  }

  a, a:visited {
    color: #1899eb;
  }
}
</style>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    table.head, table.foot { width: 100%; }
    td.head-rtitle, td.foot-os { text-align: right; }
    td.head-vol { text-align: center; }
    .Nd, .Bf, .Op { display: inline; }
    .Pa, .Ad { font-style: italic; }
    .Ms { font-weight: bold; }
    .Bl-diag > dt { font-weight: bold; }
    code.Nm, .Fl, .Cm, .Ic, code.In, .Fd, .Fn, .Cd { font-weight: bold;
      font-family: inherit; }
  </style>
  <title>install::TempContent::Objects::mod_perl-2.0.9::docs::api::Apache2::SubProcess(3)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">install::TempContent::Objects::mod_perl-2.0.9::docs::api::Apache2::SubProcess(3)</td>
    <td class="head-vol">User Contributed Perl Documentation</td>
    <td class="head-rtitle">install::TempContent::Objects::mod_perl-2.0.9::docs::api::Apache2::SubProcess(3)</td>
  </tr>
</table>
<div class="manual-text">
<br/>
<section class="Sh">
<h1 class="Sh" id="NAME"><a class="permalink" href="#NAME">NAME</a></h1>
<p class="Pp">Apache2::SubProcess -- Executing SubProcesses under mod_perl</p>
</section>
<section class="Sh">
<h1 class="Sh" id="Synopsis"><a class="permalink" href="#Synopsis">Synopsis</a></h1>
<pre>  use Apache2::SubProcess ();
  
  use Config;
  use constant PERLIO_IS_ENABLED =&gt; $Config{useperlio};
  
  # pass @ARGV / read from the process
  $command = &quot;/tmp/argv.pl&quot;;
  @argv = qw(foo bar);
  $out_fh = $r-&gt;spawn_proc_prog($command, \@argv);
  $output = read_data($out_fh);
  
  # pass environment / read from the process
  $command = &quot;/tmp/env.pl&quot;;
  $r-&gt;subprocess_env-&gt;set(foo =&gt; &quot;bar&quot;);
  $out_fh = $r-&gt;spawn_proc_prog($command);
  $output = read_data($out_fh);
  
  # write to/read from the process
  $command = &quot;/tmp/in_out_err.pl&quot;;
  ($in_fh, $out_fh, $err_fh) = $r-&gt;spawn_proc_prog($command);
  print $in_fh &quot;hello\n&quot;;
  $output = read_data($out_fh);
  $error  = read_data($err_fh);
  
  # helper function to work w/ and w/o perlio-enabled Perl
  sub read_data {
      my ($fh) = @_;
      my $data;
      if (PERLIO_IS_ENABLED || IO::Select-&gt;new($fh)-&gt;can_read(10)) {
          $data = &lt;$fh&gt;;
      }
      return defined $data ? $data : '';
  }
  
  # pass @ARGV but don't ask for any communication channels
  $command = &quot;/tmp/argv.pl&quot;;
  @argv = qw(foo bar);
  $r-&gt;spawn_proc_prog($command, \@argv);
</pre>
</section>
<section class="Sh">
<h1 class="Sh" id="Description"><a class="permalink" href="#Description">Description</a></h1>
<p class="Pp"><span class="Li">&quot;Apache2::SubProcess&quot;</span> provides
    the Perl API for running and communicating with processes spawned from
    mod_perl handlers.</p>
<p class="Pp">At the moment it's possible to spawn only external program in a
    new process. It's possible to provide other interfaces, e.g. executing a
    sub-routine reference (via <span class="Li">&quot;B::Deparse&quot;</span>)
    and may be spawn a new program in a thread (since the APR api includes API
    for spawning threads, e.g. that's how it's running mod_cgi on win32).</p>
</section>
<section class="Sh">
<h1 class="Sh" id="API"><a class="permalink" href="#API">API</a></h1>
<section class="Ss">
<h2 class="Ss" id="_spawn_proc_prog_"><a class="permalink" href="#_spawn_proc_prog_">&quot;spawn_proc_prog&quot;</a></h2>
<p class="Pp">Spawn a sub-process and return STD communication pipes:</p>
<p class="Pp"></p>
<pre>                               $r-&gt;spawn_proc_prog($command);
                               $r-&gt;spawn_proc_prog($command, \@argv);
  $out_fh                    = $r-&gt;spawn_proc_prog($command);
  $out_fh                    = $r-&gt;spawn_proc_prog($command, \@argv);
  ($in_fh, $out_fh, $err_fh) = $r-&gt;spawn_proc_prog($command);
  ($in_fh, $out_fh, $err_fh) = $r-&gt;spawn_proc_prog($command, \@argv);
</pre>
<dl class="Bl-tag">
  <dt id="obj:"><a class="permalink" href="#obj:">obj: $r (
    &quot;Apache2::RequestRec object&quot; )</a></dt>
  <dd></dd>
  <dt id="arg1:"><a class="permalink" href="#arg1:">arg1: $command ( string
    )</a></dt>
  <dd>The command to be <span class="Li">&quot;$exec()&quot;</span>'ed.</dd>
  <dt id="opt"><a class="permalink" href="#opt">opt arg2: &quot;\@argv&quot; (
    ARRAY ref )</a></dt>
  <dd>A reference to an array of arguments to be passed to the process as the
      process' <span class="Li">&quot;ARGV&quot;</span>.</dd>
  <dt id="ret:"><a class="permalink" href="#ret:">ret: ...</a></dt>
  <dd>In VOID context returns no filehandles (all std streams to the spawned
      process are closed).
    <p class="Pp">In SCALAR context returns the output filehandle of the spawned
        process (the in and err std streams to the spawned process are
      closed).</p>
    <p class="Pp">In LIST context returns the input, outpur and error
        filehandles of the spawned process.</p>
  </dd>
  <dt id="since:"><a class="permalink" href="#since:">since: 2.0.00</a></dt>
  <dd></dd>
</dl>
<p class="Pp">It's possible to pass environment variables as well, by
  calling:</p>
<p class="Pp"></p>
<pre>  $r-&gt;subprocess_env-&gt;set($key =&gt; $value);
</pre>
<p class="Pp">before spawning the subprocess.</p>
<p class="Pp">There is an issue with reading from the read filehandle
    (<span class="Li">$in_fh</span>)):</p>
<p class="Pp">A pipe filehandle returned under perlio-disabled Perl needs to
    call <b>select()</b> if the other end is not fast enough to send the data,
    since the read is non-blocking.</p>
<p class="Pp">A pipe filehandle returned under perlio-enabled Perl on the other
    hand does the <b>select()</b> internally, because it's really a filehandle
    opened via <span class="Li">&quot;:APR&quot;</span> layer, which internally
    uses APR to communicate with the pipe. The way APR is implemented Perl's
    <b>select()</b> cannot be used with it (mainly because <b>select()</b> wants
    <b>fileno()</b> and APR is a crossplatform implementation which hides the
    internal datastructure).</p>
<p class="Pp">Therefore to write a portable code, you want to use select for
    perlio-disabled Perl and do nothing for perlio-enabled Perl, hence you can
    use something similar to the <span class="Li">&quot;read_data()&quot;</span>
    wrapper shown in the Synopsis section.</p>
<p class="Pp">Several examples appear in the Synopsis section.</p>
<p class="Pp"><span class="Li">&quot;spawn_proc_prog()&quot;</span> is similar
    to <span class="Li">&quot;fork()&quot;</span>, but provides you a better
    framework to communicate with that process and handles the cleanups for you.
    But that means that just like <span class="Li">&quot;fork()&quot;</span> it
    gives you a different process, so you don't use the current Perl interpreter
    in that new process. If you try to use that method or fork to run a
    high-performance parallel processing you should look elsewhere. You could
    try Perl threads, but they are <b>very</b> expensive to start if you have a
    lot of things loaded into memory (since
    <span class="Li">&quot;perl_clone()&quot;</span> dups almost everything in
    the perl land, but the opcode tree). In the mod_perl &quot;paradigm&quot;
    this is much more expensive than fork, since normally most of the time we
    have lots of perl things loaded into memory. Most likely the best solution
    here is to offload the job to PPerl or some other daemon, with the only
    added complexity of communication.</p>
<p class="Pp">To spawn a completely independent process, which will be able to
    run after Apache has been shutdown and which won't prevent Apache from
    restarting (releasing the ports Apache is listening to) call
    <b>spawn_proc_prog()</b> in a void context and make the script detach and
    close/reopen its communication streams. For example, spawn a process as:</p>
<p class="Pp"></p>
<pre>  use Apache2::SubProcess ();
  $r-&gt;spawn_proc_prog ('/path/to/detach_script.pl', $args);
</pre>
<p class="Pp">and the <i>/path/to/detach_script.pl</i> contents are:</p>
<p class="Pp"></p>
<pre>  # file:detach_script.pl
  #!/usr/bin/perl -w
  use strict;
  use warnings;
  
  use POSIX 'setsid';
  
  chdir '/'                or die &quot;Can't chdir to /: $!&quot;;
  open STDIN, '/dev/null'  or die &quot;Can't read /dev/null: $!&quot;;
  open STDOUT, '+&gt;&gt;', '/path/to/apache/error_log'
      or die &quot;Can't write to /dev/null: $!&quot;;
  open STDERR, '&gt;&amp;STDOUT'  or die &quot;Can't dup stdout: $!&quot;;
  setsid or die &quot;Can't start a new session: $!&quot;;
  
  # run your code here or call exec to another program
</pre>
<p class="Pp">reopening (or closing) the STD streams and called
    <span class="Li">&quot;setsid()&quot;</span> makes sure that the process is
    now fully detached from Apache and has a life of its own.
    <span class="Li">&quot;chdir()&quot;</span> ensures that no partition is
    tied, in case you need to remount it.</p>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="See_Also"><a class="permalink" href="#See_Also">See
  Also</a></h1>
<p class="Pp">mod_perl 2.0 documentation.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="Copyright"><a class="permalink" href="#Copyright">Copyright</a></h1>
<p class="Pp">mod_perl 2.0 and its core modules are copyrighted under The Apache
    Software License, Version 2.0.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="Authors"><a class="permalink" href="#Authors">Authors</a></h1>
<p class="Pp">The mod_perl development team and numerous contributors.</p>
</section>
</div>
<table class="foot">
  <tr>
    <td class="foot-date">2015-06-18</td>
    <td class="foot-os">perl v5.30.2</td>
  </tr>
</table>
</body>
</html>
