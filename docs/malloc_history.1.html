<!DOCTYPE html>
<html>
<!-- This is an automatically generated file.  Do not edit.
   Copyright (c) 2000-2019 Apple Inc. All rights reserved.
 -->
<head>

<style>
@media (prefers-color-scheme: dark) {
  body {
    background: #000;
    color: #d0d0d0;
  }

  a, a:visited {
    color: #1899eb;
  }
}
</style>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    table.head, table.foot { width: 100%; }
    td.head-rtitle, td.foot-os { text-align: right; }
    td.head-vol { text-align: center; }
    .Nd, .Bf, .Op { display: inline; }
    .Pa, .Ad { font-style: italic; }
    .Ms { font-weight: bold; }
    .Bl-diag > dt { font-weight: bold; }
    code.Nm, .Fl, .Cm, .Ic, code.In, .Fd, .Fn, .Cd { font-weight: bold;
      font-family: inherit; }
  </style>
  <title>malloc_history(1)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">malloc_history(1)</td>
    <td class="head-vol">General Commands Manual</td>
    <td class="head-rtitle">malloc_history(1)</td>
  </tr>
</table>
<div class="manual-text">
<section class="Sh">
<h1 class="Sh" id="NAME"><a class="permalink" href="#NAME">NAME</a></h1>
<p class="Pp"><code class="Nm">malloc_history</code> &#x2014;
    <span class="Nd">Show the malloc and anonymous VM allocations that the
    process has performed</span></p>
</section>
<section class="Sh">
<h1 class="Sh" id="SYNOPSIS"><a class="permalink" href="#SYNOPSIS">SYNOPSIS</a></h1>
<table class="Nm">
  <tr>
    <td><code class="Nm">malloc_history</code></td>
    <td><var class="Ar">process</var> [<code class="Fl">-highWaterMark</code>]
      <var class="Ar">address</var> [<var class="Ar">address ...</var>]</td>
  </tr>
</table>
<p class="Pp"></p>
<br/>
<table class="Nm">
  <tr>
    <td><code class="Nm">malloc_history</code></td>
    <td><var class="Ar">process</var> <code class="Fl">-allBySize</code>
      [<code class="Fl">-highWaterMark</code>] [<var class="Ar">address
      ...</var>]</td>
  </tr>
</table>
<p class="Pp"></p>
<br/>
<table class="Nm">
  <tr>
    <td><code class="Nm">malloc_history</code></td>
    <td><var class="Ar">process</var> <code class="Fl">-allByCount</code>
      [<code class="Fl">-highWaterMark</code>] [<var class="Ar">address
      ...</var>]</td>
  </tr>
</table>
<p class="Pp"></p>
<br/>
<table class="Nm">
  <tr>
    <td><code class="Nm">malloc_history</code></td>
    <td><var class="Ar">process</var> <code class="Fl">-allEvents</code>
      [<code class="Fl">-highWaterMark</code>]
      [<code class="Fl">-showContent</code>]</td>
  </tr>
</table>
<p class="Pp"></p>
<br/>
<table class="Nm">
  <tr>
    <td><code class="Nm">malloc_history</code></td>
    <td><var class="Ar">process</var> <code class="Fl">-callTree</code>
      [<code class="Fl">-highWaterMark</code>]
      [<code class="Fl">-showContent</code>] [<code class="Fl">-invert</code>]
      [<code class="Fl">-ignoreThreads</code>]
      [<code class="Fl">-collapseRecursion</code>]
      [<code class="Fl">-chargeSystemLibraries</code>]
      [<code class="Fl">-virtual</code>] [<var class="Ar">address ...</var> |
      <var class="Ar">&lt;classes-pattern&gt;</var>]
    <p class="Pp"><var class="Ar">process</var> is a pid, executable-name, or
        memory-graph-file</p>
    </td>
  </tr>
</table>
</section>
<section class="Sh">
<h1 class="Sh" id="DESCRIPTION"><a class="permalink" href="#DESCRIPTION">DESCRIPTION</a></h1>
<p class="Pp"><code class="Nm">malloc_history</code> inspects a given process
    and lists the malloc and anonymous VM allocations performed by it. Anonymous
    VM allocations are from calls such as mach_vm_allocate that allocate raw
    Virtual Memory that is not backed by a file. Allocations of the VM regions
    underlying the malloc heaps are ignored.
    <code class="Nm">malloc_history</code> relies on information provided by the
    standard malloc library when malloc stack logging has been enabled for the
    target process. See below for further information.</p>
<p class="Pp">The target process may be specified by pid or by full or partial
    name, or it can be the path of a memory graph file generated by
    <code class="Nm">leaks</code> or the Xcode Memory Graph Debugger.</p>
<p class="Pp">If the <code class="Fl">-highWaterMark</code> option is passed,
    <code class="Nm">malloc_history</code> first scans through the all malloc
    stack log records to calculate the &quot;high water mark&quot; of allocated
    memory -- i.e., the highest amount of allocated memory used at any one time
    by the target process. It then shows information about the malloc
    allocations and anonymous VM regions that were live at that time, rather
    than currently alive in the target program.</p>
<p class="Pp">The <code class="Fl">-highWaterMark</code> option requires full
    mode of MallocStackLogging, in either a live process or a memory graph file
    recorded with -fullStackHistory.</p>
<p class="Pp">By specifying one or more addresses,
    <code class="Nm">malloc_history</code> lists all allocations and
    deallocations of any malloc blocks or VM regions that started at or
    contained those addresses. For each allocation, a stack trace describing who
    called malloc or free, or mach_vm_allocate, mmap, or mach_vm_deallocate is
    listed. If you do only wish to see events for malloc blocks and VM regions
    that started at the specified address, you can grep the output for that
    address. If <code class="Fl">-highWaterMark</code> is passed, it only shows
    allocations and deallocations up to the high water mark.</p>
<p class="Pp">Alternatively, the <code class="Fl">-allBySize</code> and
    <code class="Fl">-allByCount</code> options list all allocations that are
    currently live in the target process, or were live at the high water mark.
    Frequent allocations from the same point in the program (that is, the same
    call stack) are grouped together, and output presented either from largest
    allocations to smallest, or most allocations to least. If you also specify
    one or more addresses, this output is filtered to only show information for
    malloc blocks containing those addresses.</p>
<p class="Pp">The <code class="Fl">-allEvents</code> option lists all allocation
    and free events, for all addresses, up to the current time or to the high
    water mark. This output can be voluminous. If the
    <code class="Fl">-showContent</code> option is passed, live allocations will
    have additional details as described for that option below.</p>
<p class="Pp">The <code class="Fl">-callTree</code> option generates a call tree
    of the backtraces of malloc calls and anonymous VM regions for live
    allocations in the target process, or for allocations that were live at the
    high water mark. The call tree can be filtered to backtraces of specific
    allocations or classes, by passing one or more addresses or a
    &lt;classes-pattern&gt;.</p>
<p class="Pp">The &lt;classes-pattern&gt; regular expression is interpreted as
    an extended (modern) regular expression as described by the re_format(7)
    manual page. &quot;malloc&quot; or &quot;non-object&quot; can be used to
    refer to blocks that are not of any specific type. Examples of valid
    classes-patterns include:</p>
<div class="Bd-indent">
<dl class="Bl-tag Bl-compact">
  <dt>CFString</dt>
  <dd style="width: auto;">&#x00A0;</dd>
  <dt>'NS.*'</dt>
  <dd style="width: auto;">&#x00A0;</dd>
  <dt>'__NSCFString|__NSCFArray'</dt>
  <dd style="width: auto;">&#x00A0;</dd>
  <dt>'.*(String|Array)'</dt>
  <dd style="width: auto;">&#x00A0;</dd>
  <dt>'VM:.*'</dt>
  <dd style="width: auto;">&#x00A0;</dd>
  <dt>malloc</dt>
  <dd style="width: auto;">&#x00A0;</dd>
  <dt>non-object</dt>
  <dd style="width: auto;">&#x00A0;</dd>
  <dt>malloc|.*String</dt>
  <dd style="width: auto;">&#x00A0;</dd>
</dl>
</div>
<p class="Pp">The &lt;classes-pattern&gt; pattern can be followed by an optional
    allocation size specifier, which can be one of the following forms. The
    square brackets are required. The size can include a 'k' suffix for
    kilobytes, or an 'm' suffix for megabytes:</p>
<div class="Bd-indent">
<dl class="Bl-tag Bl-compact">
  <dt>[size]</dt>
  <dd style="width: auto;">&#x00A0;</dd>
  <dt>[lowerBound-upperBound]</dt>
  <dd style="width: auto;">&#x00A0;</dd>
  <dt>[lowerBound+]</dt>
  <dd style="width: auto;">&#x00A0;</dd>
  <dt>[-upperBound]</dt>
  <dd style="width: auto;">&#x00A0;</dd>
</dl>
</div>
<p class="Pp">Examples of &lt;classes-pattern&gt; with size specifications
    include:</p>
<div class="Bd-indent">
<dl class="Bl-tag Bl-compact">
  <dt>malloc[2048]</dt>
  <dd>all malloc blocks of size 2048</dd>
  <dt>malloc[1k-8k]</dt>
  <dd>all malloc blocks between 1k and 8k</dd>
  <dt>'(NS|CF).*[10k+]'</dt>
  <dd>all NS or CF objects 10k or larger</dd>
  <dt>[-1024]</dt>
  <dd>all allocations 1024 bytes or less</dd>
  <dt>VM.*[1m+]</dt>
  <dd>all Virtual Memory regions of size 1m or larger; by default this is
      dirty+swapped-volative size, unless the -virtual flag is passed</dd>
</dl>
</div>
<p class="Pp">The call tree format is similar to the output from
    <a class="Xr">sample(1)</a>. The resulting call tree can be filtered or
    pruned with the <a class="Xr">filtercalltree(1)</a> tool for further
    analysis. Additional options for the <code class="Fl">-callTree</code> mode
    include:</p>
<div class="Bd-indent">
<dl class="Bl-tag">
  <dt id="showContent"><a class="permalink" href="#showContent"><code class="Fl">-showContent</code></a></dt>
  <dd>Show the content of malloc blocks of various types, including C strings,
      Pascal strings (with a length byte at the start), and various objects
      including NSString, NSDate, and NSNumber.</dd>
  <dt id="invert"><a class="permalink" href="#invert"><code class="Fl">-invert</code></a></dt>
  <dd>Invert the call tree, so that malloc (and the allocated content, if the
      <code class="Fl">-showContent</code> option was given) show at the top of
      the call trees.</dd>
  <dt id="ignoreThreads"><a class="permalink" href="#ignoreThreads"><code class="Fl">-ignoreThreads</code></a></dt>
  <dd>Combine the call trees for all threads into a single call tree.</dd>
  <dt id="collapseRecursion"><a class="permalink" href="#collapseRecursion"><code class="Fl">-collapseRecursion</code></a></dt>
  <dd>Collapse recursion within the call trees.</dd>
  <dt id="chargeSystemLibraries"><a class="permalink" href="#chargeSystemLibraries"><code class="Fl">-chargeSystemLibraries</code></a></dt>
  <dd>Remove stack frames from all libraries in /System and /usr, while still
      charging their cost (number of calls, allocation size, and content) to the
      callers.</dd>
  <dt id="virtual"><a class="permalink" href="#virtual"><code class="Fl">-virtual</code></a></dt>
  <dd>Display the size of VM regions as the virtual size, rather than the
      default dirty + swapped/compressed - purgableVolatile.</dd>
</dl>
</div>
<p class="Pp">All modes require the standard malloc library's debugging facility
    to be turned on. To do this, set either the MallocStackLogging or
    MallocStackLoggingNoCompact environment variable to 1 in the shell that will
    run the program. If MallocStackLogging is used, then when recording events,
    if an allocation event for an address is immediately followed by a free
    event for the same address, both events are removed from the event log. If
    MallocStackLoggingNoCompact is used, then all such immediate allocation/free
    pairs are kept in the event log, which can be useful when examining all
    events for a specific address, or when using the -allEvents option.</p>
<p class="Pp">If both MallocStackLogging and MallocStackLoggingNoCompact are
    set, then MallocStackLogging takes precedence and
    MallocStackLoggingNoCompact is ignored.</p>
<p class="Pp"><code class="Nm">malloc_history</code> is particularly useful for
    tracking down memory smashers. Run the program to be inspected with
    MallocStackLogging or MallocStackLoggingNoCompact defined. Also set the
    environment variable MallocScribble; this causes the malloc library to
    overwrite freed memory with a well-known value (0x55), and occasionally
    checks freed malloc blocks to make sure the memory has not been overwritten
    since it was cleared. When malloc detects the memory has been written, it
    will print out a warning that the buffer was modified after being freed. You
    can then use <code class="Nm">malloc_history</code> to find who allocated
    and freed memory at that address, and thus deduce what parts of the code
    might still have a pointer to the freed structure.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="EXAMPLE"><a class="permalink" href="#EXAMPLE">EXAMPLE</a></h1>
<p class="Pp">To see backtraces of allocations by class type or malloc size, run
    this command:</p>
<div class="Bd Pp Li">
<pre>% malloc_history &lt;process&gt; -callTree -invert -showContent</pre>
</div>
</section>
<section class="Sh">
<h1 class="Sh" id="SEE_ALSO"><a class="permalink" href="#SEE_ALSO">SEE
  ALSO</a></h1>
<p class="Pp"><a class="Xr">malloc(3)</a>, <a class="Xr">heap(1)</a>,
    <a class="Xr">leaks(1)</a>, <a class="Xr">stringdups(1)</a>,
    <a class="Xr">vmmap(1)</a>, <a class="Xr">filtercalltree(1)</a>,
    <a class="Xr">DevToolsSecurity(1)</a></p>
<p class="Pp">The Xcode developer tools also include Instruments, a graphical
    application that can give information similar to that provided by
    <code class="Nm">malloc_history.</code> The Allocations instrument
    graphically displays dynamic, real-time information about the object and
    memory use in an application, including backtraces of where the allocations
    occurred.</p>
</section>
</div>
<table class="foot">
  <tr>
    <td class="foot-date">Oct. 7, 2019</td>
    <td class="foot-os">Mac OS X 14</td>
  </tr>
</table>
</body>
</html>
