<!DOCTYPE html>
<html>
<!-- This is an automatically generated file.  Do not edit.
   Automatically generated by Pod::Man 4.11 (Pod::Simple 3.35)
  
   Standard preamble:
   ========================================================================
   Vertical space (when we can't use .PP)
 -->
<head>

<style>
@media (prefers-color-scheme: dark) {
  body {
    background: #000;
    color: #d0d0d0;
  }

  a, a:visited {
    color: #1899eb;
  }
}
</style>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    table.head, table.foot { width: 100%; }
    td.head-rtitle, td.foot-os { text-align: right; }
    td.head-vol { text-align: center; }
    .Nd, .Bf, .Op { display: inline; }
    .Pa, .Ad { font-style: italic; }
    .Ms { font-weight: bold; }
    .Bl-diag > dt { font-weight: bold; }
    code.Nm, .Fl, .Cm, .Ic, code.In, .Fd, .Fn, .Cd { font-weight: bold;
      font-family: inherit; }
  </style>
  <title>Mail::DKIM::ARC::Verifier(3)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">Mail::DKIM::ARC::Verifier(3)</td>
    <td class="head-vol">User Contributed Perl Documentation</td>
    <td class="head-rtitle">Mail::DKIM::ARC::Verifier(3)</td>
  </tr>
</table>
<div class="manual-text">
<br/>
<section class="Sh">
<h1 class="Sh" id="NAME"><a class="permalink" href="#NAME">NAME</a></h1>
<p class="Pp">Mail::DKIM::ARC::Verifier - verifies an ARC-Sealed message</p>
</section>
<section class="Sh">
<h1 class="Sh" id="SYNOPSIS"><a class="permalink" href="#SYNOPSIS">SYNOPSIS</a></h1>
<pre>  use Mail::DKIM::ARC::Verifier;
  # create a verifier object
  my $arc = Mail::DKIM::ARC::Verifier-&gt;new();
  # read an email from a file handle
  $arc-&gt;load(*STDIN);
  # or read an email and pass it into the verifier, incrementally
  while (&lt;STDIN&gt;)
  {
      # remove local line terminators
      chomp;
      s/\015$//;
      # use SMTP line terminators
      $arc-&gt;PRINT(&quot;$_\015\012&quot;);
  }
  $arc-&gt;CLOSE;
  # what is the result of the verify?
  my $result = $arc-&gt;result;
  # print the results for all the message-signatures and seals on the message
  foreach my $signature ($arc-&gt;signatures)
  {
      print $signature-&gt;prefix() . ' v=' . $signature-&gt;instance .
                                     ' ' . $signature-&gt;result_detail . &quot;\n&quot;;
  }
  # example output.  Note that to pass, only the MOST RECENT ARC-Message-Signature
  # must match, because other steps may have modified the signature.  What matters
  # is that all ARC-Seals pass, and the most recent ARC-Message-Signature passes.
</pre>
</section>
<section class="Sh">
<h1 class="Sh" id="DESCRIPTION"><a class="permalink" href="#DESCRIPTION">DESCRIPTION</a></h1>
<p class="Pp">The verifier object allows an email message to be scanned for ARC
    seals and their associated signatures to be verified. The verifier tracks
    the state of the message as it is read into memory. When the message has
    been completely read, the signatures are verified and the results of the
    verification can be accessed.</p>
<p class="Pp">To use the verifier, first create the verifier object. Then start
    &quot;feeding&quot; it the email message to be verified. When all the
    _headers_ have been read, the verifier:</p>
<p class="Pp"></p>
<pre> 1. checks whether any ARC signatures were found
 2. queries for the public keys needed to verify the signatures
 3. sets up the appropriate algorithms and canonicalization objects
 4. canonicalizes the headers and computes the header hash
</pre>
<p class="Pp">Then, when the _body_ of the message has been completely fed into
    the verifier, the body hash is computed and the signatures are verified.</p>
<p class="Pp">The results of the verification can be checked with
    &quot;<b>result()</b>&quot; or &quot;<b>signatures()</b>&quot;.</p>
<p class="Pp">The final result is calculated by the algorithm layed out in
    https://tools.ietf.org/html/draft-ietf-dmarc-arc-protocol-06 - if ALL
    ARC-Seal headers pass and the highest index (i=) ARC-Message-Signature
    passes, then the seal is intact.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="CONSTRUCTOR"><a class="permalink" href="#CONSTRUCTOR">CONSTRUCTOR</a></h1>
<section class="Ss">
<h2 class="Ss"><b>new()</b></h2>
<p class="Pp">Constructs an object-oriented verifier.</p>
<p class="Pp"></p>
<pre>  my $arc = Mail::DKIM::ARC::Verifier-&gt;new();
  my $arc = Mail::DKIM::ARC::Verifier-&gt;new(%options);
</pre>
<p class="Pp">The only options supported at this time are:</p>
<dl class="Bl-tag">
  <dt id="AS_Canonicalization"><a class="permalink" href="#AS_Canonicalization">AS_Canonicalization</a></dt>
  <dd>if specified, the canonicalized message for the ARC-Seal is written to the
      referenced string or file handle.</dd>
  <dt id="AMA_Canonicalization"><a class="permalink" href="#AMA_Canonicalization">AMA_Canonicalization</a></dt>
  <dd>if specified, the canonicalized message for the ARC-Message-Signature is
      written to the referenced string or file handle.</dd>
  <dt id="Strict"><a class="permalink" href="#Strict">Strict</a></dt>
  <dd>If true, rejects sha1 hashes and signing keys shorter than 1024 bits.</dd>
</dl>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="METHODS"><a class="permalink" href="#METHODS">METHODS</a></h1>
<section class="Ss">
<h2 class="Ss"><b>PRINT()</b></h2>
<p class="Pp">Feeds part of the message to the verifier.</p>
<p class="Pp"></p>
<pre>  $arc-&gt;PRINT(&quot;a line of the message\015\012&quot;);
  $arc-&gt;PRINT('more of');
  $arc-&gt;PRINT(&quot; the message\015\012bye\015\012&quot;);
</pre>
<p class="Pp">Feeds content of the message being verified into the verifier. The
    API is designed this way so that the entire message does NOT need to be read
    into memory at once.</p>
<p class="Pp">Please note that although the <b>PRINT()</b> method expects you to
    use SMTP-style line termination characters, you should NOT use the
    SMTP-style dot-stuffing technique described in RFC 2821 section 4.5.2. Nor
    should you use a &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt; sequence to
    terminate the message.</p>
</section>
<section class="Ss">
<h2 class="Ss"><b>CLOSE()</b></h2>
<p class="Pp">Call this when finished feeding in the message.</p>
<p class="Pp"></p>
<pre>  $arc-&gt;CLOSE;
</pre>
<p class="Pp">This method finishes the canonicalization process, computes a
    hash, and verifies the signature.</p>
</section>
<section class="Ss">
<h2 class="Ss"><b>load()</b></h2>
<p class="Pp">Load the entire message from a file handle.</p>
<p class="Pp"></p>
<pre>  $arc-&gt;load($file_handle);
</pre>
<p class="Pp">Reads a complete message from the designated file handle, feeding
    it into the verifier. The message must use &lt;CRLF&gt; line terminators
    (same as the SMTP protocol).</p>
</section>
<section class="Ss">
<h2 class="Ss"><b>message_originator()</b></h2>
<p class="Pp">Access the &quot;From&quot; header.</p>
<p class="Pp"></p>
<pre>  my $address = $arc-&gt;message_originator;
</pre>
<p class="Pp">Returns the &quot;originator address&quot; found in the message,
    as a Mail::Address object. This is typically the (first) name and email
    address found in the From: header. If there is no From: header, then an
    empty Mail::Address object is returned.</p>
<p class="Pp">To get just the email address part, do:</p>
<p class="Pp"></p>
<pre>  my $email = $arc-&gt;message_originator-&gt;address;
</pre>
<p class="Pp">See also &quot;<b>message_sender()</b>&quot;.</p>
</section>
<section class="Ss">
<h2 class="Ss"><b>message_sender()</b></h2>
<p class="Pp">Access the &quot;From&quot; or &quot;Sender&quot; header.</p>
<p class="Pp"></p>
<pre>  my $address = $arc-&gt;message_sender;
</pre>
<p class="Pp">Returns the &quot;sender&quot; found in the message, as a
    Mail::Address object. This is typically the (first) name and email address
    found in the Sender: header. If there is no Sender: header, it is the first
    name and email address in the From: header. If neither header is present,
    then an empty Mail::Address object is returned.</p>
<p class="Pp">To get just the email address part, do:</p>
<p class="Pp"></p>
<pre>  my $email = $arc-&gt;message_sender-&gt;address;
</pre>
<p class="Pp">The &quot;sender&quot; is the mailbox of the agent responsible for
    the actual transmission of the message. For example, if a secretary were to
    send a message for another person, the &quot;sender&quot; would be the
    secretary and the &quot;originator&quot; would be the actual author.</p>
</section>
<section class="Ss">
<h2 class="Ss"><b>result()</b></h2>
<p class="Pp">Access the result of the verification.</p>
<p class="Pp"></p>
<pre>  my $result = $arc-&gt;result;
</pre>
<p class="Pp">Gives the result of the verification. The following values are
    possible:</p>
<dl class="Bl-tag">
  <dt id="pass"><a class="permalink" href="#pass">pass</a></dt>
  <dd>Returned if a valid ARC chain was found, with all the ARC-Seals passing,
      and the most recent (highest index) ARC-Message-Signature passing.</dd>
  <dt id="fail"><a class="permalink" href="#fail">fail</a></dt>
  <dd>Returned if any ARC-Seal failed, or if the ARC-Message-Signature failed.
      Will also be a fail if there is a DNS temporary failure, which is a known
      flaw in this version of the ARC::Verifier. Future versions may reject this
      message outright (4xx) and ask the sender to attempt delivery later to
      avoid creating a broken chain. There is no temperror for ARC, as it
      doesn't make sense to sign a chain with temperror in it or every spammer
      would just use one of those.</dd>
  <dt id="invalid"><a class="permalink" href="#invalid">invalid</a></dt>
  <dd>Returned if a ARC-Seal could not be checked because of a problem in the
      signature itself or the public key record. I.e. the signature could not be
      processed.</dd>
  <dt id="none"><a class="permalink" href="#none">none</a></dt>
  <dd>Returned if no ARC-* headers were found.</dd>
</dl>
</section>
<section class="Ss">
<h2 class="Ss"><b>result_detail()</b></h2>
<p class="Pp">Access the result, plus details if available.</p>
<p class="Pp"></p>
<pre>  my $detail = $dkim-&gt;result_detail;
</pre>
<p class="Pp">The detail is constructed by taking the result (e.g.
    &quot;pass&quot;, &quot;fail&quot;, &quot;invalid&quot; or &quot;none&quot;)
    and appending any details provided by the verification process for the
    topmost ARC-Seal in parenthesis.</p>
<p class="Pp">The following are possible results from the <b>result_detail()</b>
    method:</p>
<p class="Pp"></p>
<pre>  pass
  fail (bad RSA signature)
  fail (OpenSSL error: ...)
  fail (message has been altered)
  fail (body has been altered)
  invalid (bad instance)
  invalid (invalid domain in d tag)
  invalid (missing q tag)
  invalid (missing d tag)
  invalid (missing s tag)
  invalid (unsupported version 0.1)
  invalid (unsupported algorithm ...)
  invalid (unsupported canonicalization ...)
  invalid (unsupported query protocol ...)
  invalid (signature is expired)
  invalid (public key: not available)
  invalid (public key: unknown query type ...)
  invalid (public key: syntax error)
  invalid (public key: unsupported version)
  invalid (public key: unsupported key type)
  invalid (public key: missing p= tag)
  invalid (public key: invalid data)
  invalid (public key: does not support email)
  invalid (public key: does not support hash algorithm 'sha1')
  invalid (public key: does not support signing subdomains)
  invalid (public key: revoked)
  invalid (public key: granularity mismatch)
  invalid (public key: granularity is empty)
  invalid (public key: OpenSSL error: ...)
  none
</pre>
</section>
<section class="Ss">
<h2 class="Ss"><b>signatures()</b></h2>
<p class="Pp">Access all of this message's signatures.</p>
<p class="Pp"></p>
<pre>  my @all_signatures = $arc-&gt;signatures;
</pre>
<p class="Pp">Use <span class="Li">$signature</span>-&gt;result or
    <span class="Li">$signature</span>-&gt;result_detail to access the
    verification results of each signature.</p>
<p class="Pp">Use <span class="Li">$signature</span>-&gt;instance and
    <span class="Li">$signature</span>-&gt;prefix to find the instance and
    header-name for each signature.</p>
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="AUTHOR"><a class="permalink" href="#AUTHOR">AUTHOR</a></h1>
<p class="Pp">Bron Gondwana, &lt;brong@fastmailteam.com&gt;</p>
</section>
<section class="Sh">
<h1 class="Sh" id="COPYRIGHT_AND_LICENSE"><a class="permalink" href="#COPYRIGHT_AND_LICENSE">COPYRIGHT
  AND LICENSE</a></h1>
<p class="Pp">Copyright (C) 2017 FastMail Pty Ltd.</p>
<p class="Pp">This library is free software; you can redistribute it and/or
    modify it under the same terms as Perl itself, either Perl version 5.8.6 or,
    at your option, any later version of Perl 5 you may have available.</p>
</section>
</div>
<table class="foot">
  <tr>
    <td class="foot-date">2019-11-13</td>
    <td class="foot-os">perl v5.30.2</td>
  </tr>
</table>
</body>
</html>
