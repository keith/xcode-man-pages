<!DOCTYPE html>
<html>
<!-- This is an automatically generated file.  Do not edit.
   Automatically generated by Pod::Man 4.14 (Pod::Simple 3.42)
  
   Standard preamble:
   ========================================================================
   Vertical space (when we can't use .PP)
 -->
<head>

<style>
@media (prefers-color-scheme: dark) {
  body {
    background: #000;
    color: #d0d0d0;
  }

  a, a:visited {
    color: #1899eb;
  }
}
</style>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    table.head, table.foot { width: 100%; }
    td.head-rtitle, td.foot-os { text-align: right; }
    td.head-vol { text-align: center; }
    .Nd, .Bf, .Op { display: inline; }
    .Pa, .Ad { font-style: italic; }
    .Ms { font-weight: bold; }
    .Bl-diag > dt { font-weight: bold; }
    code.Nm, .Fl, .Cm, .Ic, code.In, .Fd, .Fn, .Cd { font-weight: bold;
      font-family: inherit; }
  </style>
  <title>Test2::Manual::Anatomy::EndToEnd(3)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">Test2::Manual::Anatomy::EndToEnd(3)</td>
    <td class="head-vol">User Contributed Perl Documentation</td>
    <td class="head-rtitle">Test2::Manual::Anatomy::EndToEnd(3)</td>
  </tr>
</table>
<div class="manual-text">
<br/>
<section class="Sh">
<h1 class="Sh" id="NAME"><a class="permalink" href="#NAME">NAME</a></h1>
<p class="Pp">Test2::Manual::EndToEnd - Overview of Test2 from load to
  finish.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="DESCRIPTION"><a class="permalink" href="#DESCRIPTION">DESCRIPTION</a></h1>
<p class="Pp">This is a high level overview of everything from loading Test2
    through the end of a test script.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="WHAT_HAPPENS_WHEN_I_LOAD_THE_API?"><a class="permalink" href="#WHAT_HAPPENS_WHEN_I_LOAD_THE_API?">WHAT
  HAPPENS WHEN I LOAD THE API?</a></h1>
<pre>    use Test2::API qw/context/;
</pre>
<dl class="Bl-tag">
  <dt id="A"><a class="permalink" href="#A">A singleton instance of
    Test2::API::Instance is created.</a></dt>
  <dd>You have no access to this, it is an implementation detail.</dd>
  <dt id="Several"><a class="permalink" href="#Several">Several API functions
    are defined that use the singleton instance.</a></dt>
  <dd>You can import these functions, or use them directly.</dd>
  <dt id="Then"><a class="permalink" href="#Then">Then what?</a></dt>
  <dd>It waits...
    <p class="Pp">The API intentionally does as little as possible. At this
        point something can still change the formatter, load Test2::IPC, or have
        other global effects that need to be done before the first
        Test2::API::Context is created. Once the first Test2::API::Context is
        created the API will finish initialization.</p>
    <p class="Pp">See &quot;WHAT HAPPENS WHEN I ACQUIRE A CONTEXT?&quot; for
        more information.</p>
  </dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="WHAT_HAPPENS_WHEN_I_USE_A_TOOL?"><a class="permalink" href="#WHAT_HAPPENS_WHEN_I_USE_A_TOOL?">WHAT
  HAPPENS WHEN I USE A TOOL?</a></h1>
<p class="Pp">This section covers the basic workflow all tools such as
    <span class="Li">&quot;ok()&quot;</span> must follow.</p>
<p class="Pp"></p>
<pre>    sub ok($$) {
        my ($bool, $name) = @_;
        my $ctx = context();
        my $event = $ctx-&gt;send_event('Ok', pass =&gt; $bool, name =&gt; $name);
        ...
        $ctx-&gt;release;
        return $bool;
    }
    ok(1, &quot;1 is true&quot;);
</pre>
<dl class="Bl-tag">
  <dt id="A~2"><a class="permalink" href="#A~2">A tool function is run.</a></dt>
  <dd>
    <pre>    ok(1, &quot;1 is true&quot;);
    </pre>
  </dd>
  <dt id="The"><a class="permalink" href="#The">The tool acquires a context
    object.</a></dt>
  <dd>
    <pre>    my $ctx = context();
    </pre>
    <p class="Pp">See &quot;WHAT HAPPENS WHEN I ACQUIRE A CONTEXT?&quot; for
        more information.</p>
  </dd>
  <dt id="The~2"><a class="permalink" href="#The~2">The tool uses the context
    object to create, send, and return events.</a></dt>
  <dd>See &quot;WHAT HAPPENS WHEN I SEND AN EVENT?&quot; for more information.
    <p class="Pp"></p>
    <pre>    my $event = $ctx-&gt;send_event('Ok', pass =&gt; $bool, name =&gt; $name);
    </pre>
  </dd>
  <dt id="When"><a class="permalink" href="#When">When done the tool MUST
    release the context.</a></dt>
  <dd>See &quot;WHAT HAPPENS WHEN I RELEASE A CONTEXT?&quot; for more
      information.
    <p class="Pp"></p>
    <pre>    $ctx-&gt;release();
    </pre>
  </dd>
  <dt id="The~3"><a class="permalink" href="#The~3">The tool returns.</a></dt>
  <dd>
    <pre>    return $bool;
    </pre>
  </dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="WHAT_HAPPENS_WHEN_I_ACQUIRE_A_CONTEXT?"><a class="permalink" href="#WHAT_HAPPENS_WHEN_I_ACQUIRE_A_CONTEXT?">WHAT
  HAPPENS WHEN I ACQUIRE A CONTEXT?</a></h1>
<pre>    my $ctx = context();
</pre>
<p class="Pp">These actions may not happen exactly in this order, but that is an
    implementation detail. For the purposes of this document this order is used
    to help the reader understand the flow.</p>
<dl class="Bl-tag">
  <dt>$!, $@, $? and $^E are captured and preserved.</dt>
  <dd>Test2 makes a point to preserve the values of $!, $@, $? and $^E such that
      the test tools do not modify these variables unexpectedly. They are
      captured first thing so that they can be restored later.</dd>
  <dt id="The~4"><a class="permalink" href="#The~4">The API state is changed to
    'loaded'.</a></dt>
  <dd>The 'loaded' state means that test tools have already started running.
      This is important as some plugins need to take effect before any tests are
      run. This state change only happens the first time a context is acquired,
      and may trigger some hooks defined by plugins to run.</dd>
  <dt id="The~5"><a class="permalink" href="#The~5">The current hub is
    found.</a></dt>
  <dd>A context attaches itself to the current Test2::Hub. If there is no
      current hub then the root hub will be initialized. This will also
      initialize the hub stack if necessary.</dd>
  <dt id="Context"><a class="permalink" href="#Context">Context acquire hooks
    fire.</a></dt>
  <dd>It is possible to create global, or hub-specific hooks that fire whenever
      a context is acquired, these hooks will fire now. These hooks fire even if
      there is an existing context.</dd>
  <dt id="Any"><a class="permalink" href="#Any">Any existing context is
    found.</a></dt>
  <dd>If the current hub already has a context then a clone of it will be used
      instead of a completely new context. This is important because it allows
      nested tools to inherit the context used by parent tools.</dd>
  <dt id="Stack"><a class="permalink" href="#Stack">Stack depth is
    measured.</a></dt>
  <dd>Test2 makes a point to catch mistakes in how the context is used. The
      stack depth is used to accomplish this. If there is an existing context
      the depth will be checked against the one found here. If the old context
      has the same stack depth, or a shallower one, it means a tool is
      misbehaving and did not clean up the context when it was done, in which
      case the old context will be cleaned up, and a warning issued.</dd>
  <dt id="A~3"><a class="permalink" href="#A~3">A new context is created (if no
    existing context was found)</a></dt>
  <dd>If there is no existing context, a new one will be created using the data
      collected so far.</dd>
  <dt id="Context~2"><a class="permalink" href="#Context~2">Context init hooks
    fire (if no existing context was found)</a></dt>
  <dd>If a new context was created, context-creation hooks will fire.</dd>
  <dt>$!, $@, $?, and $^E are restored.</dt>
  <dd>We make sure $!, $@, $?, and $^E are unchanged at this point so that
      changes we made will not effect anything else. This is done in case
      something inside the context construction accidentally changed these
    vars.</dd>
  <dt id="The~6"><a class="permalink" href="#The~6">The context is
    returned.</a></dt>
  <dd>You have a shiney new context object, or a clone of the existing
    context.</dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="WHAT_HAPPENS_WHEN_I_SEND_AN_EVENT?"><a class="permalink" href="#WHAT_HAPPENS_WHEN_I_SEND_AN_EVENT?">WHAT
  HAPPENS WHEN I SEND AN EVENT?</a></h1>
<pre>    my $event = $ctx-&gt;send_event('Ok', pass =&gt; $bool, name =&gt; $name);
</pre>
<dl class="Bl-tag">
  <dt id="The~7"><a class="permalink" href="#The~7">The Test2::Event::Ok module
    is loaded.</a></dt>
  <dd>The <span class="Li">&quot;send_event()&quot;</span> method will
      automatically load any Event package necessary. Normally
      <span class="Li">&quot;send_event()&quot;</span> will assume the first
      argument is an event class without the
      <span class="Li">&quot;Test2::Event::&quot;</span> prefix, which it will
      add for you. If you want to use an event class that is in a different
      namespace you can prefix the class name with a
      <span class="Li">&quot;+&quot;</span> to tell the tool that you are giving
      a fully qualified class name:
    <p class="Pp"></p>
    <pre>    my $event = $ctx-&gt;send_event('+Fully::Qualified::Event', pass =&gt; $bool, name =&gt; $name);
    </pre>
  </dd>
  <dt id="A~4"><a class="permalink" href="#A~4">A new instance of
    Test2::Event::Ok is created.</a></dt>
  <dd>The event object is instantiated using the provided parameters.</dd>
  <dt id="The~8"><a class="permalink" href="#The~8">The event object is sent to
    the hub.</a></dt>
  <dd>The hub takes over from here.</dd>
  <dt id="The~9"><a class="permalink" href="#The~9">The hub runs the event
    through any filters.</a></dt>
  <dd>Filters are able to modify or remove events. Filters are run first, before
      the event can modify global test state.</dd>
  <dt id="The~10"><a class="permalink" href="#The~10">The global test state is
    updated to reflect the event.</a></dt>
  <dd>If the event effects test count then the count will be incremented. If the
      event causes failure then the failure count will be incremented. There are
      a couple other ways the global state can be effected as well.</dd>
  <dt id="The~11"><a class="permalink" href="#The~11">The event is sent to the
    formatter</a></dt>
  <dd>After the state is changed the hub will send the event to the formatter
      for rendering. This is where TAP is normally produced.</dd>
  <dt id="The~12"><a class="permalink" href="#The~12">The event is sent to all
    listeners.</a></dt>
  <dd>There can be any number of listeners that take action when events are
      processed, this happens now.</dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="WHAT_HAPPENS_WHEN_I_RELEASE_A_CONTEXT?"><a class="permalink" href="#WHAT_HAPPENS_WHEN_I_RELEASE_A_CONTEXT?">WHAT
  HAPPENS WHEN I RELEASE A CONTEXT?</a></h1>
<pre>    $ctx-&gt;release;
</pre>
<dl class="Bl-tag">
  <dt id="The~13"><a class="permalink" href="#The~13">The current context clone
    is released.</a></dt>
  <dd>If your tool is nested inside another, then releasing will simply destroy
      the copy of the context, nothing else will happen.</dd>
  <dt id="If"><a class="permalink" href="#If">If this was the canonical context,
    it will actually release</a></dt>
  <dd>When a context is created it is considered 'canon'. Any context obtained
      by a nested tool will be considered a child context linked to the
      canonical one. Releasing child contexts does not do anything of note (but
      is still required).</dd>
  <dt id="Release"><a class="permalink" href="#Release">Release hooks are
    called</a></dt>
  <dd>Release hooks are the main motivation behind making the
      <span class="Li">&quot;release()&quot;</span> method, and making it a
      required action on the part of test tools. These are hooks that we can
      have called when a tool is complete. This is how plugins like
      Test2::Plugin::DieOnFail are implemented. If we simply had a destructor
      call the hooks then we would be unable to write this plugin as a
      <span class="Li">&quot;die&quot;</span> inside of a destructor is
    useless.</dd>
  <dt id="The~14"><a class="permalink" href="#The~14">The context is
    cleared</a></dt>
  <dd>The main context data is cleared allowing the next tool to create a new
      context. This is important as the next tool very likely has a new line
      number.</dd>
  <dt>$!, $@, $?, and $^E are restored</dt>
  <dd>When a Test2 tool is complete it will restore $@, $!, $? and $^E to avoid
      action at a distance.</dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="WHAT_HAPPENS_WHEN_I_USE_"><a class="permalink" href="#WHAT_HAPPENS_WHEN_I_USE_">WHAT
  HAPPENS WHEN I USE <b>done_testing()</b>?</a></h1>
<pre>    done_testing();
</pre>
<dl class="Bl-tag">
  <dt id="Any~2"><a class="permalink" href="#Any~2">Any pending IPC events will
    be culled.</a></dt>
  <dd>If IPC is turned on, a final culling will take place.</dd>
  <dt id="Follow-up"><a class="permalink" href="#Follow-up">Follow-up hooks are
    run</a></dt>
  <dd>The follow-up hooks are a way to run actions when a hub is complete. This
      is useful for adding cleanup tasks, or final tests to the end of a
    test.</dd>
  <dt id="The~15"><a class="permalink" href="#The~15">The final plan event is
    generated and processed.</a></dt>
  <dd>The final plan event will be produced using the current test count as the
      number of tests planned.</dd>
  <dt id="The~16"><a class="permalink" href="#The~16">The current hub is
    finalized.</a></dt>
  <dd>This will mark the hub is complete, and will not allow new events to be
      processed.</dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="WHAT_HAPPENS_WHEN_A_TEST_SCRIPT_IS_DONE?"><a class="permalink" href="#WHAT_HAPPENS_WHEN_A_TEST_SCRIPT_IS_DONE?">WHAT
  HAPPENS WHEN A TEST SCRIPT IS DONE?</a></h1>
<p class="Pp">Test2 has some behaviors it runs in an <span class="Li">&quot;END
    { ... }&quot;</span> block after tests are done running. This end block does
    some final checks to warn you if something went wrong. This end block also
    sets the exit value of the script.</p>
<dl class="Bl-tag">
  <dt id="API"><a class="permalink" href="#API">API Versions are
    checked.</a></dt>
  <dd>A warning will be produced if Test::Builder is loaded, but has a different
      version compared to Test2::API. This situation can happen if you downgrade
      to an older Test-Simple distribution, and is a bad situation.</dd>
  <dt id="Any~3"><a class="permalink" href="#Any~3">Any remaining context
    objects are cleaned up.</a></dt>
  <dd>If there are leftover context objects they will need to be cleaned up. A
      leftover context is never a good thing, and usually requires a warning. A
      leftover context could also be the result of an exception being thrown
      which terminates the script, Test2 is fairly good at noticing this and not
      warning in these cases as the warning would simply be noise.</dd>
  <dt id="Child"><a class="permalink" href="#Child">Child processes are sent a
    'waiting' event.</a></dt>
  <dd>If IPC is active, a waiting event is sent to all child processes.</dd>
  <dt id="The~17"><a class="permalink" href="#The~17">The script will wait for
    all child processes and/or threads to complete.</a></dt>
  <dd>This happens only when IPC is loaded, but Test::Builder is not. This
      behavior is useful, but would break compatibility for legacy tests.</dd>
  <dt id="The~18"><a class="permalink" href="#The~18">The hub stack is cleaned
    up.</a></dt>
  <dd>All hubs are finalized starting from the top. Leftover hubs are usually a
      bad thing, so a warning is produced if any are found.</dd>
  <dt id="The~19"><a class="permalink" href="#The~19">The root hub is
    finalized.</a></dt>
  <dd>This step is a no-op if <span class="Li">&quot;done_testing()&quot;</span>
      was used. If needed this will mark the root hub as finished.</dd>
  <dt id="Exit"><a class="permalink" href="#Exit">Exit callbacks are
    called.</a></dt>
  <dd>This is a chance for plugins to modify the final exit value of the
    script.</dd>
  <dt id="The~20"><a class="permalink" href="#The~20">The scripts exit value
    ($?) is set.</a></dt>
  <dd>If the test encountered any failures this will be set to a non-zero value.
      If possible this will be set to the number of failures, or 255 if the
      number is larger than 255 (the max value allowed).</dd>
  <dt id="Broken"><a class="permalink" href="#Broken">Broken module
    diagnostics</a></dt>
  <dd>Test2 is aware of many modules which were broken by Test2's release. At
      this point the script will check if any known-broken modules were loaded,
      and warn you if they were.
    <p class="Pp"><b>Note:</b> This only happens if there were test failures. No
        broken module warnings are produced on a success.</p>
  </dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="SEE_ALSO"><a class="permalink" href="#SEE_ALSO">SEE
  ALSO</a></h1>
<p class="Pp">Test2::Manual - Primary index of the manual.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="SOURCE"><a class="permalink" href="#SOURCE">SOURCE</a></h1>
<p class="Pp">The source code repository for Test2-Manual can be found at
    <i>https://github.com/Test-More/Test2-Suite/</i>.</p>
</section>
<section class="Sh">
<h1 class="Sh" id="MAINTAINERS"><a class="permalink" href="#MAINTAINERS">MAINTAINERS</a></h1>
<dl class="Bl-tag">
  <dt id="Chad"><a class="permalink" href="#Chad">Chad Granum
    &lt;exodist@cpan.org&gt;</a></dt>
  <dd></dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="AUTHORS"><a class="permalink" href="#AUTHORS">AUTHORS</a></h1>
<dl class="Bl-tag">
  <dt id="Chad~2"><a class="permalink" href="#Chad~2">Chad Granum
    &lt;exodist@cpan.org&gt;</a></dt>
  <dd></dd>
</dl>
</section>
<section class="Sh">
<h1 class="Sh" id="COPYRIGHT"><a class="permalink" href="#COPYRIGHT">COPYRIGHT</a></h1>
<p class="Pp">Copyright 2018 Chad Granum &lt;exodist@cpan.org&gt;.</p>
<p class="Pp">This program is free software; you can redistribute it and/or
    modify it under the same terms as Perl itself.</p>
<p class="Pp">See <i>http://dev.perl.org/licenses/</i></p>
</section>
</div>
<table class="foot">
  <tr>
    <td class="foot-date">2020-10-22</td>
    <td class="foot-os">perl v5.34.0</td>
  </tr>
</table>
</body>
</html>
