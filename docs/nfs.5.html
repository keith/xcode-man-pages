<!DOCTYPE html>
<html>
<!-- This is an automatically generated file.  Do not edit.
   Copyright (c) 2017 Apple Inc.  All rights reserved.
  
   @APPLE_LICENSE_HEADER_START@
  
   This file contains Original Code and/or Modifications of Original Code
   as defined in and that are subject to the Apple Public Source License
   Version 2.0 (the 'License'). You may not use this file except in
   compliance with the License. Please obtain a copy of the License at
   http://www.opensource.apple.com/apsl/ and read it before using this
   file.
  
   The Original Code and all software distributed under the License are
   distributed on an 'AS IS' basis, WITHOUT WARRANTY OF ANY KIND, EITHER
   EXPRESS OR IMPLIED, AND APPLE HEREBY DISCLAIMS ALL SUCH WARRANTIES,
   INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT OR NON-INFRINGEMENT.
   Please see the License for the specific language governing rights and
   limitations under the License.
  
   @APPLE_LICENSE_HEADER_END@
   -->
<head>

<style>
@media (prefers-color-scheme: dark) {
  body {
    background: #000;
    color: #d0d0d0;
  }

  a, a:visited {
    color: #1899eb;
  }
}
</style>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    table.head, table.foot { width: 100%; }
    td.head-rtitle, td.foot-os { text-align: right; }
    td.head-vol { text-align: center; }
    .Nd, .Bf, .Op { display: inline; }
    .Pa, .Ad { font-style: italic; }
    .Ms { font-weight: bold; }
    .Bl-diag > dt { font-weight: bold; }
    code.Nm, .Fl, .Cm, .Ic, code.In, .Fd, .Fn, .Cd { font-weight: bold;
      font-family: inherit; }
  </style>
  <title>NFS(5)</title>
</head>
<body>
<table class="head">
  <tr>
    <td class="head-ltitle">NFS(5)</td>
    <td class="head-vol">File Formats Manual</td>
    <td class="head-rtitle">NFS(5)</td>
  </tr>
</table>
<div class="manual-text">
<section class="Sh">
<h1 class="Sh" id="NAME"><a class="permalink" href="#NAME">NAME</a></h1>
<p class="Pp"><code class="Nm">NFS</code> &#x2014; <span class="Nd">Network File
    System</span></p>
</section>
<section class="Sh">
<h1 class="Sh" id="SYNOPSIS"><a class="permalink" href="#SYNOPSIS">SYNOPSIS</a></h1>
<table class="Nm">
  <tr>
    <td><code class="Nm">NFS</code></td>
    <td></td>
  </tr>
</table>
</section>
<section class="Sh">
<h1 class="Sh" id="DESCRIPTION"><a class="permalink" href="#DESCRIPTION">DESCRIPTION</a></h1>
<p class="Pp">NFS is the standard <span class="Ux">UNIX</span> file sharing
    protocol suite. MacOS supports version two, NFSv2 (RFC 1094), version three,
    NFSv3 (RFC 1813), and in addition for the client, version four, NFSv4 (RFC
    3530). NFSv2 and NFSv3 also rely on adjunct protocols for mounting, Mountd
    (RFC 1094, RFC 1813) and for locking, NLM (OpenGroup XNFS). NFSv4 subsumes
    both mount and locking operations in to it's protocol. MacOS systems support
    TCP over IPv4 and IPv6. In addition for versions two and three of the
    protocol, UDP is supported over IPv4 and IPv6, however its use is
    discouraged. Version two of the protocol is considered legacy and should
    only be used if higher versions of the protocol are unavailable.</p>
<p class="Pp">As part of macOS Ventura (macOS 13.0), NFS client code was moved
    out from kernel into kernel extension (kext). The new kext is now loaded by
    default on boot. Hence, from the user perspective, there is no difference
    from the previous releases. This behavior will change in a future release,
    i.e., NFS kext will not be loaded on boot but automatically when
    <code class="Ic">mount_nfs</code> is called (
    <code class="Ic">NetFSFramework</code> and <code class="Ic">autofs</code>
    use <code class="Ic">mount_nfs</code> in order to mount) or manually using
    <code class="Ic">kextload</code> tool. This means that
    <var class="Ar">mount(&quot;nfs&quot;, ...)</var> syscall would fail with
    ENODEV and NFS client sysctl parameters will not be available until kext is
    up.</p>
<section class="Ss">
<h2 class="Ss" id="MacOS_Extended_Attribute_Considerations"><a class="permalink" href="#MacOS_Extended_Attribute_Considerations">MacOS
  Extended Attribute Considerations</a></h2>
<p class="Pp">MacOS makes heavy use of extended attributes, resource forks, and
    possibly ACLs. NFSv2 and NFSv3 do not support these operations over the
    wire. The getting and setting of ACLs are not supported but extended
    attributes and resource forks for MacOS clients are supported by storing
    extended attributes and resource forks in an &quot;Apple Double&quot; (also
    known as a dot under bar file) files on the server. On the other hand NFSv4
    can optionally support ACLs. And can optionally support the storing of
    resource forks and extended attributes as NFSv4 named attributes. Previous
    versions of NFSv4 on MacOS would use NFSv4 named attributes if supported by
    the server for storing extended attributes and resource forks, however this
    version of NFSv4 defaults to using &quot;Apple Double&quot; files. If a
    server exports files systems with both NFSv3 and NFSv4 (the usual default
    case) and supports named attributes as well, then there is a potential for
    data loss, since changing an extended attribute or resource fork from an
    NFSv3 client is not visible to an NFSv4 client and visa versa. If the server
    is known to only have NFSv4 clients or is only exporting file systems with
    NFSv4 then MacOS clients should use the <var class="Ar">namedattr</var>
    option. See <a class="Xr">mount_nfs(8)</a>. If converting from NFSv3 to
    NFSv4 only with named attribute support, the following procedure can be use
    to convert the &quot;Apple Double&quot; files to NFSv4 named attributes.</p>
<p class="Pp">Be sure that the file system on the server has no other MacOS NFS
    mounts. Then allow one MacOS NFSv4 client that has been mounted with the
    <var class="Ar">namedattr</var> mount option (<code class="Ic">mount</code>
    <code class="Fl">-o</code> <var class="Ar">vers=4,namedattr</var>), to mount
    the export(s) on the server. Then at the mount point on the client run the
    <code class="Ic">dot_clean</code> <code class="Fl">-m</code> command. This
    will read the &quot;Apple Double&quot; files and convert them to native
    extended attributes on the server and then remove the &quot;Apple
    Double&quot; file.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="MacOS_ACL_support."><a class="permalink" href="#MacOS_ACL_support.">MacOS
  ACL support.</a></h2>
<p class="Pp">ACLs (access control list) are enforced at the server not the
    client. As mentioned above NFSv3/NFSv2 do not support ACLs. So it is
    possible to get access or permission errors even though the BSD permission
    bits indicate that a file system operation should succeed. MacOS NFSv4
    clients can optionally support ACLs if the <var class="Ar">acl</var> or
    <var class="Ar">aclonly</var> options are given at mount time. The reason
    that ACLs are not enabled by default is that there interpretation can be
    different from one server to another. Particularly in the way
    <span class="Ux">BSD</span> mode bits are interpreted. A simplified
    explanation for MacOS, is that it interprets ACLs by running over the list
    of ACEs (access control entries) in order and if all requests for access
    have been granted and no request for access has been denied then the access
    is granted. If no request has been denied but some request have not been
    granted then fall back to the <span class="Ux">BSD</span> access
    permissions. A complete description of ACLs can be found in &quot;Appendix
    B, File System Details&quot; in the
    <a class="permalink" href="#File"><i class="Em" id="File">File System
    Programming Guide</i></a>. Also see <var class="Ar">acl</var>,
    <var class="Ar">noacl</var>, and <var class="Ar">aclonly</var> in
    <a class="Xr">mount_nfs(8)</a> for more details. Future version of MacOS may
    enable ACL support by default.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="NFSv4_Name_mapping."><a class="permalink" href="#NFSv4_Name_mapping.">NFSv4
  Name mapping.</a></h2>
<p class="Pp">Unlike NFSv3/NFSv2 identities for owners and groups are
    represented by strings instead of 32 bit numbers. Thus NFSv4 clients and
    servers have to convert these over the wire string identities to the local
    identities and local identities to strings. These strings are principally
    used in GETATTR, SETATTR, and ACEs for security identities. Note that the
    RPC credential is used for permission and access checking for whether an
    operation will be allowed. Those credentials are found in the RPC header,
    such as a kerberos identity that is associated with the RPCSEC_GSS context.
    These strings are of the form &quot;identity@NFSv4Domain&quot;, where the
    &quot;NFSv4Domain&quot; follows DNS domain naming conventions.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="NFSv4_Mirror_Mounts."><a class="permalink" href="#NFSv4_Mirror_Mounts.">NFSv4
  Mirror Mounts.</a></h2>
<p class="Pp">While crossing file system boundries on the server side, nfs
    client will automatically create mount points on the client side. Such mount
    points will be marked as <var class="Ar">ephemeral</var> in
    <code class="Ic">nfsstat -m</code> output. Mount options are inherited from
    the parent mount point.</p>
</section>
<section class="Ss">
<h2 class="Ss" id="MacOS_NFSv4_name_mapping_rules."><a class="permalink" href="#MacOS_NFSv4_name_mapping_rules.">MacOS
  NFSv4 name mapping rules.</a></h2>
<p class="Pp">When processing identities by default we first check and see if
    the idenity string from the server is a string of digits if so we use that
    as the uid/gid to ask Open Directory to map that to a local idenitity. If
    that fails or the idenity string is not a string of digits we next check for
    well known names that NFSv4 supports. These names are of the form
    &quot;identity@&quot; with no domain part. If we match any of the
  following</p>
<table class="Bl-column Bd-indent">
  <tr>
    <td>OWNER@</td>
    <td>GROUP@</td>
    <td>EVERYONE@</td>
  </tr>
  <tr>
    <td>INTERACTIVE@</td>
    <td>NETWORK@</td>
    <td>DIALUP@</td>
  </tr>
  <tr>
    <td>BATCH@</td>
    <td>ANONYMOUS@</td>
    <td>AUTHENTICATED@</td>
  </tr>
  <tr>
    <td>SERVICE@</td>
  </tr>
</table>
<p class="Pp">These identities are mapped to Open Directory internal identities.
    Along with any other identity that ends in an &quot;@&quot;, which are
    mapped to nobody. These well known identities are used as generic security
    idenitifiers in ACEs. These identities are mapped back to the above strings
    when going back over the wire to the server. If the identites do not match
    the strings ending in &quot;@&quot; then we attempt to map the identities as
    follows. MacOS clients support a zero configuration option by not specifying
    a default NFSv4 domain. String identies coming from the server are handed as
    is to Open Directory to translate the string identity to the local identity.
    This works if the NFSv4 domain is the same as an Open Directory node name.
    Local identies are similarly translated to the fully scoped Open Directory
    names on the way out. If Open Directory returns an error in trying to map
    the identities we then by default try to use the following fall back
    idenities:</p>
<table class="Bl-column Bd-indent">
  <tr>
    <td>root@any_domain</td>
    <td>wheel@any_domain</td>
  </tr>
  <tr>
    <td>nobody@any_domain</td>
    <td>nfsnobody@any_domain</td>
  </tr>
</table>
<p class="Pp">Root and wheel identities are translated by Open Directory with
    uid/gid of zero and nobody and nfsnobody are traslated to uid/gid of -2
    (MacOS internal representation for the nobody uid/gid).</p>
<p class="Pp">This is useful in situations where the client and server do not
    share a common naming database. It is recommended where sites have a large
    number of MacOS clients, set their NFSv4 domain to be the LDAP node that is
    being used to bind Open Directory so that there is no other configuration
    needed for the Mac clients.</p>
<p class="Pp">For environments which have a different NFSv4 domain name from the
    bound LDAP node name, the NFSv4 domain name needs to be set by editing
    <span class="Pa">/etc/nfs.conf</span> and adding the line</p>
<div class="Bd Bd-indent"><code class="Li">nfs.client.default_nfs4domain =
  &lt;my_nfsv4_domain&gt;</code></div>
See <a class="Xr">nfs.conf(5)</a>. The rules for mapping are then as follows. If
  a string identity comes in over the wire whose domain portion matches the
  client's NFSv4 domain, then its stripped off and that unscoped name is this
  given to Open Directory to map to a local identity. On the way back to the
  server any Open Directory node name is stripped off and the NFSv4 domain name
  is appended. If the identity coming from the server does not match the NFSv4
  domain name, then its passed to Open Directory as is and the rules described
  above for having no NFSv4 domain name set are followed.
</section>
</section>
<section class="Sh">
<h1 class="Sh" id="Examples"><a class="permalink" href="#Examples">Examples</a></h1>
<p class="Pp">The server has set its NFSv4 domain that is not the same as any
    MacOS client Open Directory node, so that the identity mapping is not set up
    correctly. Users will see output like the following example:</p>
<div class="Bd Pp Li">
<pre>3-$ ls -l /tmp/mp
total 16851
-rw-r--r--  1 nobody  nobody       29 Oct 12  2015 Foo.txt
drwxr-xr-x  3 nobody  nobody        4 Jan 31 16:27 Q102/
drwxrwxrwx  3 nobody  nobody        7 Jan 24 16:59 acl/
-rw-r--r--  1 nobody  wheel         0 Feb  8 11:54 file1
-rw-r--r--  1 root    wheel         0 Feb  8 12:00 file2
-rw-r--r--  1 nobody  nobody        0 Feb  9 11:06 fooby
drwx------  2 nobody  nobody        5 Sep 22  2015 keyring-GbeUpi/
drwx------  2 65432   nobody        5 Sep  8  2015 keyring-OX5G6P/</pre>
</div>
<p class="Pp">Most of the mappings comeback as &quot;nobody/nobody&quot;. Note
    &quot;file1&quot; comes back with group wheel. This is an example of fall
    back identity mapping. Similarly for &quot;file2&quot; for both the user and
    group return root and wheel respectfully. The directory
    &quot;keyring-OX5G6P&quot; has ownership of 65432 this is because the server
    could not map that id locally and so sent it over the wire as a string of
    digits. After correcting the NFSv4 domain on the server we have:</p>
<div class="Bd Pp Li">
<pre>4-$ ls -l /tmp/mp
total 16851
-rw-r--r--  1 lbricker  staff        29 Oct 12  2015 Foo.txt
drwxr-xr-x  3 lbricker  staff         4 Jan 31 16:27 Q102/
drwxrwxrwx  3 lbricker  staff         7 Jan 24 16:59 acl/
-rw-r--r--  1 lbricker  staff         0 Feb  8 11:54 file1
-rw-r--r--  1 root      nobody        0 Feb  8 12:00 file2
-rw-r--r--  1 lbricker  nobody        0 Feb  9 11:06 fooby
drwx------  2 lbricker  staff         5 Sep 22  2015 keyring-GbeUpi/
drwx------  2 65432     staff         5 Sep  8  2015 keyring-OX5G6P/</pre>
</div>
<p class="Pp">What is surprising is that file1 and file2's group is now nobody.
    The reason is that the server is sending those group ids as
    &quot;root@&lt;open_directroy_node&gt;&quot;. Open Directory will not find
    that mapping so it will map it to nobody (had
    &quot;wheel@&lt;open_directory_node&quot; had been used, wheel would have
    been returned). In the previous example the server sent
    &quot;root@bogus.nfsv4.com&quot;. Open Directory will now return an error
    since it can not find a valid Open Directory node
    &quot;bogus.nfsv4.com&quot; and thus use the fall back to a gid of 0.</p>
<p class="Pp">Debugging NFSv4 name mapping can be done with the
    <code class="Ic">nfs4mapid</code> command. See
    <a class="Xr">nfs4mapid(8)</a>. This allows testing of name/identity
    translations by using a system call into the kernel that calls the same
    routines as the MacOS nfs client uses. For example we determine the group
    translations above.</p>
<div class="Bd Pp Li">
<pre>83-$ sudo nfs4mapid -G root@nod.apple.com
group root@nod.apple.com maps to id -2
    mapping done through guid ABCDEFAB-CDEF-ABCD-EFAB-CDEFFFFFFFFE
84-$ sudo nfs4mapid -G wheel@nod.apple.com
group wheel@nod.apple.com maps to id 0
    mapping done through guid ABCDEFAB-CDEF-ABCD-EFAB-CDEF00000000
85-$ sudo nfs4mapid -G wheel@foobar.com
group wheel@foobar.com maps to id 0
    mapping done through guid ABCDEFAB-CDEF-ABCD-EFAB-CDEF00000000
86-$ sudo nfs4mapid -G root@foobar.com group
root@foobar.com maps to id 0
    mapping done through guid ABCDEFAB-CDEF-ABCD-EFAB-CDEF00000000</pre>
</div>
</section>
<section class="Sh">
<h1 class="Sh" id="See_Also"><a class="permalink" href="#See_Also">See
  Also</a></h1>
<p class="Pp"><cite class="Rs"><span class="RsT">Appendix B, File System
    Details</span>, <i class="RsB">File System Programming Guide</i>,
    <i class="RsI">Apple</i>,
    <span class="RsO">https://developer.apple.com</span>.</cite></p>
<p class="Pp"><a class="Xr">dot_clean(1)</a>, <a class="Xr">nfsstat(1)</a>,
    <a class="Xr">nfs.conf(5)</a>, <a class="Xr">nfs4mapid(8)</a>,
    <a class="Xr">mount_nfs(8)</a>, <a class="Xr">opendirectoryd(8)</a>,
    <a class="Xr">kextload(8)</a></p>
</section>
<section class="Sh">
<h1 class="Sh" id="Standards"><a class="permalink" href="#Standards">Standards</a></h1>
<dl class="Bl-tag">
  <dt>[RFC1094]</dt>
  <dd><cite class="Rs"><span class="RsA">B. Nowicki</span>, <i class="RsB">NFS:
      Network File System Protocol specification</i>,
      <span class="RsR">RFC1094</span>, <span class="RsD">March 1989</span>,
      <span class="RsO">http://www.rfc-editor.org/info/rfc1094</span>.</cite></dd>
  <dt>[RFC1813]</dt>
  <dd><cite class="Rs"><span class="RsA">B. Callaghan</span>,
      <span class="RsA">B. Pawlowski</span>, and <span class="RsA">P.
      Staubach</span>, <i class="RsB">NFS Version 3 Protocol Specification</i>,
      <span class="RsR">RFC1813</span>, <span class="RsD">June 1995</span>,
      <span class="RsO">http://www.rfc-editor.org/info/rfc1813</span>.</cite></dd>
  <dt>[RFC3530]</dt>
  <dd><cite class="Rs"><span class="RsA">S. Shepler</span>, <span class="RsA">B.
      Callaghan</span>, <span class="RsA">D. Robinson</span>,
      <span class="RsA">R. Thurlow</span>, <span class="RsA">C. Beame</span>,
      <span class="RsA">M. Eisler</span>, and <span class="RsA">D.
      Noveck</span>, <i class="RsB">Network File System (NFS) version 4
      Protocol</i>, <span class="RsR">RFC3530</span>, <span class="RsD">April
      2003</span>,
      <span class="RsO">http://www.rfc-editor.org/info/rfc3530</span>.</cite></dd>
  <dt>[XNFS]</dt>
  <dd><cite class="Rs"><i class="RsB">Protocols for Interworking: XNFS, Version
      3W</i>, <i class="RsI">Open Group Technical Standard</i>,
      <span class="RsD">February, 1998</span>, <span class="RsO">ISBN:
      1-85912-184-5</span>.</cite></dd>
</dl>
</section>
</div>
<table class="foot">
  <tr>
    <td class="foot-date">May 25, 2017</td>
    <td class="foot-os">Mac OS X 12</td>
  </tr>
</table>
</body>
</html>
